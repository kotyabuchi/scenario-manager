# Report Schema — タスク完了報告のスキーマ定義
# 作成者: Bosun/Lookout/Carpenter → 読み手: Navigator, Captain
#
# JSON Schema Draft 2020-12 (YAML表記)
# バリデーション: pwsh -File .agents/fleet/validate.ps1 -Schema report -File <path>

$schema: "https://json-schema.org/draft/2020-12/schema"
title: Report
description: 乗組員が提出するタスク完了報告

type: object
required:
  - voyage_id
  - task_id
  - reporter
  - status
  - summary

properties:
  voyage_id:
    type: string
    pattern: "^voyage-\\d{3,}$"
    description: "航海ID"

  task_id:
    type: string
    pattern: "^task-\\d{3,}$"
    description: "タスクID"

  reporter:
    type: string
    enum: [bosun, lookout, carpenter]
    description: "報告者"

  phase:
    type: string
    enum: [green, review, refactor]
    description: "TDDフェーズ"

  status:
    type: string
    enum: [anchored, aground]
    description: |
      タスク結果:
        anchored — 完了（成功）
        aground  — 座礁（失敗）

  summary:
    type: string
    minLength: 1
    description: "作業内容の要約"

  review_target:
    type: string
    pattern: "^task-\\d{3,}$"
    description: "レビュー対象タスクID（Lookoutの場合）"

  verdict:
    type: string
    enum: [ok, ng]
    description: "レビュー判定（Lookoutの場合）"

  findings:
    type: array
    items:
      type: object
      required: [severity, issue]
      properties:
        severity:
          type: string
          enum: [minor, major, critical]
          description: "問題の深刻度"
        file:
          type: string
          description: "ファイルパス"
        line:
          type: integer
          description: "行番号"
        issue:
          type: string
          description: "問題の説明"
        suggestion:
          type: string
          description: "修正提案"
      additionalProperties: false
    description: "レビューで発見した問題（Lookout NGの場合は必須）"

  refactored_items:
    type: array
    items:
      type: object
      required: [type, description]
      properties:
        type:
          type: string
          enum: [dry, readability, performance, type_safety]
          description: "改善の種類"
        description:
          type: string
          description: "改善内容の説明"
        files:
          type: array
          items:
            type: string
          description: "対象ファイル"
      additionalProperties: false
    description: "リファクタ内容（Carpenterの場合）"

  files_changed:
    type: array
    items:
      type: string
    description: "変更したファイルパス一覧"

  changes_detail:
    type: array
    items:
      type: object
      required: [file, change]
      properties:
        file:
          type: string
          description: "ファイル名（短縮可）"
        change:
          type: string
          description: "変更内容の説明"
      additionalProperties: false
    description: "ファイルごとの変更詳細（任意）"

  commits:
    type: array
    items:
      type: object
      required: [hash, message]
      properties:
        hash:
          type: string
          description: "コミットハッシュ（短縮可）"
        message:
          type: string
          description: "コミットメッセージ"
      additionalProperties: false
    description: "作成したコミット（git操作タスクの場合）"

  new_tokens:
    type: array
    description: "新規追加したデザイントークン（トークン化タスクの場合）"

  errors:
    type: array
    items:
      type: string
    description: "発生したエラー（agroundの場合は必須）"

  learnings:
    type: array
    items:
      type: string
    description: "作業で得た学び・再利用可能なパターン"

  skill_candidate:
    type: object
    required: [name, reason]
    properties:
      name:
        type: string
        description: "スキル候補名"
      reason:
        type: string
        description: "スキル化を提案する理由"
      similar_memories:
        type: array
        items:
          type: string
        description: "類似メモリID一覧"
    additionalProperties: false
    description: "スキル候補の提案（繰り返しパターン検出時）"

additionalProperties: false

# status=aground の場合、errors は1件以上必須
if:
  properties:
    status:
      const: aground
then:
  properties:
    errors:
      minItems: 1
  required:
    - errors

# reporter=lookout かつ verdict=ng の場合、findings は1件以上必須
# （JSON Schemaの制約上、複合条件はallOfで表現）
