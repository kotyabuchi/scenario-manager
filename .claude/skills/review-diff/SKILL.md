---
name: review-diff
description: >
  最後のコミットからの未コミット差分（未追跡ファイル含む、docs/配下を除く）を多角的にレビューする。
  コーディング規約準拠、設計品質、セキュリティ、パフォーマンス、UX/a11y、バグ検出の6観点で評価。
  「差分をレビューして」「変更をレビュー」「変更をチェック」で起動。
allowed-tools:
  - Read
  - Write
  - Edit
  - Grep
  - Glob
  - Bash
  - Task
---

# Review Diff — 未コミット差分の多角的レビュー

最後のコミットからの未コミット変更（未追跡ファイル含む、`docs/` 配下を除く）を6つの観点からレビューし、`docs/reviews/` にレポートを出力する。

## When to Use

- コミット前に変更内容の品質を確認したい
- PR作成前にセルフレビューしたい
- コーディング規約への準拠状況を確認したい

## Instructions

### Step 1: 差分の取得

レビュー対象は **最後のコミット（HEAD）からの未コミット変更すべて**（ステージ済み + 未ステージ + 未追跡ファイル）。

**差分取得コマンド（docs/ を除外）:**

```bash
# 1. 変更概要の取得（tracked files: staged + unstaged）
git diff HEAD --stat -- . ":(exclude)docs/"

# 2. 変更内容の取得（tracked files: staged + unstaged）
git diff HEAD -- . ":(exclude)docs/"

# 3. 未追跡ファイルの一覧取得（docs/ を除外）
git ls-files --others --exclude-standard -- . ":(exclude)docs/"
```

未追跡ファイルがある場合は、それらのファイルも Read ツールで内容を読み取り、レビュー対象に含める。

tracked files の差分も未追跡ファイルもない場合は「レビュー対象の変更がありません」と報告して終了。

### Step 2: コンテキスト収集

レビュー精度を上げるため、以下を並列で収集する:

1. **変更ファイル一覧** — `git diff HEAD --name-only -- . ":(exclude)docs/"` + `git ls-files --others --exclude-standard -- . ":(exclude)docs/"` で取得
2. **直近コミット** — `git log -1 --oneline` で最後のコミット内容を把握（差分の起点を確認）
3. **プロジェクトルール** — 変更内容に関連する `.claude/rules/` のルールファイルを読む
   - `.tsx`/`.ts` 変更 → `typescript-rules.md`, `react-rules.md`
   - スタイル変更 → `styling-rules.md`
   - フォーム関連 → `form-rules.md`
   - エラー処理 → `error-handling.md`
4. **変更ファイルの全体像** — 差分だけでなく、変更されたファイルの前後のコードも読んで文脈を理解する

### Step 3: 6観点レビュー

各観点について、差分に該当する問題がある場合のみ指摘する。問題がなければ「問題なし」と明記。

#### 1. コーディング規約準拠

`.claude/rules/` のルールに照らして確認:

- 命名規則（ファイル名、変数名、関数名）
- Import順序
- コメント（日本語）
- any型、Non-null assertion(!)の使用禁止
- console.log の禁止（LogTape使用）
- セマンティックHTML
- スタイル分離（`styles.ts`）
- エクスポート形式（`export default` の末尾使用禁止）
- PandaCSSトークンの使用（ハードコードされた値の禁止）

#### 2. 設計・保守性

- 責務の分離（Single Responsibility）
- コンポーネント・関数の粒度は適切か
- 型安全性（Supabase生成型/Zod推論型の活用、型の二重管理の有無）
- エラーハンドリング（Result型パターンの使用）
- Null/Undefinedチェック（`isNil` の使用）
- 既存パターンとの整合性

#### 3. セキュリティ

- 入力バリデーション
- XSS/インジェクションリスク
- 認証・認可の考慮
- 機密情報のハードコード

#### 4. パフォーマンス

- 不要な再レンダリング
- N+1クエリ
- バンドルサイズへの影響（不要なクライアントコンポーネント）
- メモ化の必要性

#### 5. UX・アクセシビリティ

- WCAG 2.1 AA準拠（コントラスト比、フォーカス管理）
- キーボードナビゲーション
- スクリーンリーダー対応
- エラー状態・ローディング状態の考慮
- lucide-react アイコン使用（絵文字禁止）

#### 6. バグ・ロジックエラー

- エッジケースの見落とし
- 競合状態（Race condition）
- 型の不一致
- Off-by-oneエラー
- 非同期処理の問題（未処理のPromise等）

### Step 4: レポート出力

`docs/reviews/` に以下の形式でレポートを出力する。ディレクトリが存在しない場合は作成する。

**ファイル名**: `diff-review-YYYY-MM-DD.md`
同日に複数回実行した場合: `diff-review-YYYY-MM-DD-2.md`

#### レポートフォーマット

```markdown
# コード差分レビュー

> **レビュー日時**: YYYY-MM-DD
> **対象範囲**: HEAD からの未コミット変更（staged + unstaged + untracked）
> **変更ファイル数**: N files
> **総合評価**: {A / B / C / D}

## 変更サマリー

{2-3文で変更内容の概要}

### 変更ファイル

| ファイル | 追加 | 削除 | 種別 |
|----------|------|------|------|
| `src/...` | +N | -N | 新規/変更/削除 |

## 評価詳細

### 1. コーディング規約準拠 {OK / WARN / NG}

{評価コメント}

### 2. 設計・保守性 {OK / WARN / NG}

{評価コメント}

### 3. セキュリティ {OK / WARN / NG}

{評価コメント}

### 4. パフォーマンス {OK / WARN / NG}

{評価コメント}

### 5. UX・アクセシビリティ {OK / WARN / NG}

{評価コメント}

### 6. バグ・ロジックエラー {OK / WARN / NG}

{評価コメント}

## 指摘一覧

### 必須（マージ前に修正すべき）

| # | 観点 | ファイル:行 | 指摘事項 | 推奨対応 |
|---|------|------------|---------|---------|

### 推奨（対応が望ましい）

| # | 観点 | ファイル:行 | 指摘事項 | 推奨対応 |
|---|------|------------|---------|---------|

### 検討（余裕があれば）

| # | 観点 | ファイル:行 | 指摘事項 | 推奨対応 |
|---|------|------------|---------|---------|

## 良い点

{変更の中で良かった点を箇条書きで記載}

## 総合所見

{全体的な評価と改善の方向性}
```

#### 総合評価の基準

| 評価 | 基準 |
|------|------|
| A | 必須指摘なし。そのままマージ可能 |
| B | 軽微な改善点あり。修正後にマージ可能 |
| C | 重要な問題あり。修正が必要 |
| D | 根本的な問題あり。設計の見直しが必要 |

### Step 5: 結果の報告

ユーザーに以下を報告:
- 総合評価
- 必須/推奨/検討の指摘件数
- 必須指摘がある場合はその概要
- レポートファイルのパス

## Notes

- 差分が大きい場合（20ファイル超）は、Task エージェントを使って並列レビューを実施
- `differential-review` スキルはセキュリティ特化、本スキルは全観点バランス型という棲み分け
- 同日の既存レポートファイルがある場合は連番を付与して上書きしない
