---
name: apply-review
description: >
  review-diffスキルで作成したコードレビュー結果の指摘をソースコードに反映する。
  「レビューを反映して」「指摘を修正して」「レビュー結果を適用」で起動。
argument-hint: "[review-file-name]"
allowed-tools:
  - Read
  - Write
  - Edit
  - Grep
  - Glob
  - Bash
  - Task
---

# Apply Review - コードレビュー指摘の反映

`docs/reviews/` のコード差分レビューレポート（`review-diff` で生成）に含まれる指摘事項を、ソースコードに反映する。

## When to Use

- `/review-diff` でコードレビューを実施した後、指摘事項をコードに反映したい
- 総合評価が B〜D で修正が必要なとき
- レビュー結果をもとにコード品質を改善したい

## Instructions

### Step 1: 対象レビューファイルの特定

引数 `$ARGUMENTS` が指定されている場合:
- `docs/reviews/` 内で一致するファイルを探す（拡張子 `.md` は省略可能）

引数がない場合:
- `docs/reviews/` 内の `diff-review-*.md` ファイルを更新日時の降順で取得し、**最新のレビューファイルを自動選択**する

対象ファイルが見つからない場合はエラーメッセージを出して終了。

### Step 2: レビュー内容の分析

1. **レビューレポートを読む** - 全文を精読
2. **総合評価を確認** - A / B / C / D
3. **指摘一覧を抽出** - 必須・推奨・検討の3カテゴリに分類
4. **指摘対象ファイルの現在の状態を確認** - 各指摘のファイル:行を読み、レビュー時点からの変更有無を把握

### Step 3: ロールバックポイントの作成

修正を開始する前に、現在の変更を保存する:

```bash
git stash push -m "apply-review: before applying fixes"
```

stash 後、直ちに stash を復元して作業を続行する:

```bash
git stash pop
```

これにより、万が一修正が失敗した場合に `git checkout -- .` で stash 時点の状態に戻し、`git stash pop` で元の変更を復元できる。

### Step 4: 必須指摘の反映（ハイブリッド方式）

必須指摘を **観点に基づいて自動反映と確認付き反映に振り分ける**。

#### 自動反映する観点

以下の観点の指摘は、機械的に修正可能なため **自動で反映する**:

| 観点 | 修正例 |
|------|--------|
| 1. コーディング規約準拠 | 未使用import削除、命名規則修正、console.log除去、スタイル分離、export形式修正 |
| 4. パフォーマンス | 不要な再レンダリング防止、メモ化追加、クライアントコンポーネントの最小化 |

自動反映の手順:
1. 指摘対象ファイルの該当箇所を読む
2. レビューの「推奨対応」に従ってコードを修正する
3. 修正内容を簡潔にログ出力する（例: `✓ [規約] src/hooks/useAuth.ts: 未使用import削除`）

#### 確認後に反映する観点

以下の観点の指摘は、ロジックや設計に影響するため **ユーザーに確認してから反映する**:

| 観点 | 理由 |
|------|------|
| 2. 設計・保守性 | 責務分離やエラーハンドリングの変更は設計意図に影響する |
| 3. セキュリティ | 認証・バリデーションの変更は慎重な判断が必要 |
| 5. UX・アクセシビリティ | UI変更はユーザー体験に直接影響する |
| 6. バグ・ロジックエラー | バグ修正は根本原因の理解が必要 |

確認の手順:
1. 指摘内容と推奨対応をユーザーに提示する
2. ユーザーの承認を得てから修正する
3. ユーザーがスキップを選んだ場合はその指摘を飛ばす

表示形式:
```
### 必須指摘（確認が必要）

1. **[設計] {指摘事項}** (`{ファイル:行}`)
   推奨対応: {推奨対応}
   → 反映しますか？ (y/n/修正方針を指定)

2. ...
```

ユーザーが修正方針を指定した場合は、その方針に従って修正する。

### Step 5: 推奨・検討の確認

必須指摘の反映が完了したら、「推奨」と「検討」の指摘をユーザーに提示する。

表示形式:
```
## 推奨指摘（対応が望ましい）

1. **[観点] {指摘事項}** (`{ファイル:行}`)
   推奨対応: {推奨対応}

2. ...

## 検討指摘（余裕があれば）

1. **[観点] {指摘事項}** (`{ファイル:行}`)
   推奨対応: {推奨対応}

2. ...

反映する項目を番号で指定してください（例: 推奨1,2 検討1）
すべてスキップする場合は「なし」と入力してください。
```

ユーザーが選択した項目のみコードに反映する。

### Step 6: 修正後の検証

すべての反映が完了したら:

1. `pnpm check` を実行してlint/formatエラーがないか確認
2. エラーがあれば修正する
3. 必要に応じて `pnpm build` でビルド確認

### Step 7: レビューステータスの更新

修正が完了したら、レビューファイルの冒頭に反映ステータスを追記する。

```markdown
> **反映ステータス**: 反映済み（YYYY-MM-DD）
> **反映内容**: 必須 {N}件 + 推奨 {N}件 + 検討 {N}件
```

### Step 8: 結果の報告

修正内容のサマリーをユーザーに報告する:
- 反映した指摘の件数（必須 / 推奨 / 検討）
- 主な変更内容の要約（3-5行）
- 修正したファイル一覧
- 検証結果（pnpm check / build の結果）
- 必要に応じて再レビュー（`/review-diff`）を提案

## Error Handling

| 状況 | 対応 |
|------|------|
| レビューファイルが見つからない | `/review-diff` で先にレビューを実行するよう案内 |
| 総合評価が A | 「修正不要です」と報告して終了 |
| 指摘対象ファイルが既に変更されている | ユーザーに確認してから反映 |
| 指摘対象の行が見つからない | ファイル全体のコンテキストから該当箇所を推定する |
| 修正後に pnpm check が失敗 | エラーを修正してから続行 |

## Notes

- このスキルは `/review-diff` とペアで使う想定
- コードを修正した後、再度 `/review-diff` でレビューし、総合評価が A or B になるまで繰り返す運用を推奨
- 計画レビューの反映は `/apply-plan-review` を使用すること
