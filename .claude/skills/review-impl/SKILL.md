---
name: review-impl
description: >
  docs/plans/配下の実装計画に対して実装の充足度をレビューする。計画どおりに実装されているか確認し、
  計画に書かれていない「永続的なサービスとして足りない項目」も検出する。
  「実装をレビューして」「計画の実装確認」「プランの実装チェック」で起動。
argument-hint: "[plan-file-name]"
allowed-tools:
  - Read
  - Write
  - Edit
  - Grep
  - Glob
  - Bash
  - Task
---

# Review Implementation - 計画に対する実装充足度レビュー

`docs/plans/` のプランファイルと実際の実装を突き合わせ、**計画の充足度**と**サービスとしての完成度**の両面からレビューする。

## Position in Workflow

```
/review-plan → /apply-plan-review → /exec-plan → **★ /review-impl** → /review-diff → /commit
                                                   ↑ 実装完了後に使う
```

- `/review-plan`: 計画自体の品質をレビュー（実装前）
- `/review-diff`: 未コミット差分を汎用的にレビュー
- **`/review-impl`**: 計画に対する実装の充足度 + サービス品質をレビュー（実装後）

## When to Use

- `/exec-plan` で計画を実装した後、充足度を確認したい
- 計画どおりに実装できているか棚卸ししたい
- 計画に書かれていなかったが本番サービスとして必要な項目を洗い出したい

## Instructions

### Step 1: 対象プランの特定

引数 `$ARGUMENTS` が指定されている場合:
- `docs/plans/` 内で一致するファイルを探す（拡張子 `.md` は省略可能）

引数がない場合:
- `docs/plans/` 内の `.md` ファイルを更新日時の降順で取得し、**最新のファイルを自動選択**する
- 選択したファイル名をユーザーに表示してからレビューを開始する

対象ファイルが見つからない場合はエラーメッセージを出して終了。

### Step 2: プランの解析

プランファイルを全文読み込み、以下を抽出する:

1. **ファイル一覧** — 「新規ファイル」「変更ファイル」セクションから対象ファイルを特定
2. **各 Step の仕様** — `### Step N-M.` の内容を個別に記録
3. **決定事項** — 技術選定・設計判断
4. **検証方法** — 自動テスト・手動テストの要件

### Step 3: 実装の収集

プランで言及されている**すべてのファイル**を読み込む。
ファイルが存在しない場合は「未実装」として記録する。

並列で以下も収集:
- `git diff HEAD --stat` で現在の変更状況を把握
- プロジェクトルール（`.claude/rules/`）の関連ファイル
- 計画のレビューファイル（`docs/reviews/{plan-name}-review.md`）があれば、指摘事項の対応状況も確認

### Step 4: 計画充足度レビュー（Part A）

各 Step を1つずつ実装と突き合わせ、以下の3段階で評価する:

| 状態 | 意味 |
|------|------|
| **DONE** | 計画どおり実装完了 |
| **PARTIAL** | 一部未実装、または仕様と乖離あり |
| **MISSING** | 未実装 |

各 Step について:
- 計画で指定されたファイルが存在するか
- 計画で指定された関数・型・コンポーネントが実装されているか
- 計画の仕様（引数、戻り値、ロジック）と実装が一致しているか
- 計画の決定事項（技術選定・命名等）が守られているか

### Step 5: サービス品質レビュー（Part B）

計画に書かれていなくても、**永続的な本番サービスとして当然あるべき項目**を検出する。
以下の8つの観点で、実装に不足がないかチェックする。

#### B1. エラーハンドリング

- DB クエリの失敗に対する Result 型の使用
- Server Action のエラーレスポンス
- API 呼び出しの try-catch
- `isNil` によるnullチェック
- フォームバリデーションエラーの表示

#### B2. エッジケース・空状態

- データが0件のときの empty state UI
- 配列が空のときのフォールバック
- null / undefined が来たときの安全な表示
- 極端に長いテキスト、極端に大きい数値への対応
- 日付データの不正値（未来日・過去日・null）

#### B3. ローディング・Suspense

- Server Component のストリーミング（`loading.tsx` or `Suspense`）
- データ取得中のスケルトン UI
- 楽観的更新の対応（更新系操作がある場合）
- `useTransition` の使用

#### B4. セキュリティ

- 認証チェック（Server Component での `supabase.auth.getUser()`）
- 認可チェック（他ユーザーのデータへのアクセス制限）
- 入力のサニタイゼーション
- XSS リスク（`dangerouslySetInnerHTML` 等）

#### B5. パフォーマンス

- N+1 クエリの有無
- 不必要な `'use client'` の使用（バンドルサイズ）
- `React.cache()` によるリクエスト内重複排除
- 画像の最適化（`next/image` の使用）
- 不要な再レンダリング

#### B6. アクセシビリティ

- 見出し階層（h1→h2→h3 の順序）
- `aria-label` / `alt` テキスト
- キーボード操作可能性（`tabIndex`, フォーカス管理）
- カラーコントラスト比（WCAG AA: 4.5:1 通常、3:1 大テキスト）
- セマンティック HTML の使用

#### B7. テストカバレッジ

- 計画で指定されたテストファイルの存在
- ユニットテストの網羅性（正常系・異常系・境界値）
- Storybook ストーリーの存在
- E2E テストの必要性の検討

#### B8. プロジェクト規約準拠

- `.claude/rules/` のルールへの準拠
- 命名規則（ファイル名、変数名、スタイル名）
- スタイル分離（`styles.ts`）
- Import 順序
- LogTape の使用（console.log 禁止）
- PandaCSS セマンティックトークンの使用（ハードコード値禁止）

### Step 6: レビューレポート出力

`docs/reviews/` に以下の形式でレポートを出力する。

**ファイル名**: `{元ファイル名}-impl-review.md`
例: `dashboard-redesign.md` → `dashboard-redesign-impl-review.md`

#### レポートフォーマット

```markdown
# {計画名} 実装レビュー

> **レビュー日時**: YYYY-MM-DD
> **対象計画**: `docs/plans/{file}`
> **計画充足度**: {N}% ({done}/{total} Steps)
> **サービス品質**: {A / B / C / D}

## サマリー

{3-5文で実装状況と品質の全体評価}

---

## Part A: 計画充足度

### Batch 1: {バッチ名}

| Step | 仕様 | 状態 | 備考 |
|------|------|:----:|------|
| 1-1 | {Step名} | DONE / PARTIAL / MISSING | {差異の説明} |
| 1-2 | ... | ... | ... |

### Batch 2: {バッチ名}

| Step | 仕様 | 状態 | 備考 |
|------|------|:----:|------|
| 2-1 | ... | ... | ... |

### 計画レビュー指摘の対応状況

（`docs/reviews/{plan}-review.md` が存在する場合のみ）

| # | 指摘事項 | 対応状態 |
|---|---------|---------|
| 1 | {指摘内容} | 対応済 / 未対応 / 部分対応 |

---

## Part B: サービス品質

### B1. エラーハンドリング {OK / WARN / NG}

{評価コメントと具体的な指摘}

### B2. エッジケース・空状態 {OK / WARN / NG}

{評価コメント}

### B3. ローディング・Suspense {OK / WARN / NG}

{評価コメント}

### B4. セキュリティ {OK / WARN / NG}

{評価コメント}

### B5. パフォーマンス {OK / WARN / NG}

{評価コメント}

### B6. アクセシビリティ {OK / WARN / NG}

{評価コメント}

### B7. テストカバレッジ {OK / WARN / NG}

{評価コメント}

### B8. プロジェクト規約準拠 {OK / WARN / NG}

{評価コメント}

---

## 改善提案

### 必須（リリース前に対処すべき）

| # | 種別 | ファイル | 指摘事項 | 推奨対応 |
|---|------|---------|---------|---------|
| 1 | Part A/B | `path/to/file` | ... | ... |

### 推奨（対応が望ましい）

| # | 種別 | ファイル | 指摘事項 | 推奨対応 |
|---|------|---------|---------|---------|

### 検討（余裕があれば）

| # | 種別 | ファイル | 指摘事項 | 推奨対応 |
|---|------|---------|---------|---------|

## 良い点

{実装の中で良かった点を箇条書き}

## 総合所見

{全体的な評価と次のアクション}
```

#### 評価基準

**計画充足度**: `(DONE の Step 数) / (全 Step 数) × 100%`

**サービス品質**:

| 評価 | 基準 |
|------|------|
| A | 必須指摘なし。リリース可能 |
| B | 軽微な改善点あり。修正後にリリース可能 |
| C | 重要な不足あり。修正が必要 |
| D | 根本的な品質問題あり。大幅な追加実装が必要 |

### Step 7: 結果の報告

レビューレポートのサマリーをユーザーに報告する:
- 計画充足度（%）と PARTIAL / MISSING の Step 数
- サービス品質の総合評価
- 必須指摘の件数と概要
- 推奨・検討の件数
- レポートファイルのパス

## Notes

- このスキルは `/exec-plan` の実行後に使う想定。計画の実装前なら `/review-plan` を使う
- Part A（充足度）と Part B（品質）は独立した評価軸。充足度100%でもサービス品質がDの場合がある
- 差分が大きい場合（15ファイル超）は Task エージェントで並列にファイルを読み込む
- 同名のレビューファイルが既に存在する場合は上書きする
