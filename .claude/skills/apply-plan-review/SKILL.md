---
name: apply-plan-review
description: review-planスキルで作成したレビュー結果を元の計画に反映する。「計画レビューを反映して」「計画の指摘を反映」「計画を修正して」で起動。
argument-hint: "[plan-file-name]"
---

# Apply Plan Review - レビュー結果の計画反映

`docs/reviews/` のレビューレポートに含まれる改善提案を、対応する `docs/plans/` の計画ファイルに反映する。

## When to Use

- `/review-plan` でレビューを実施した後、指摘事項を計画に反映したい
- 計画の総合評価が B〜D で修正が必要なとき
- レビュー結果をもとに計画をブラッシュアップしたい

## Instructions

### Step 1: 対象ファイルのペア特定

引数 `$ARGUMENTS` が指定されている場合:
- `docs/plans/{引数}.md` と `docs/reviews/{引数}-review.md` のペアを探す
- 拡張子 `.md` や `-review` サフィックスは自動補完する

引数がない場合:
- `docs/reviews/` 内の `*-review.md` ファイル（`diff-review-*` を除く）を更新日時の降順で取得し、**最新のレビューファイルを自動選択**する
- レビューファイル名から元の計画ファイルを推定する（`xxx-review.md` → `docs/plans/xxx.md`）

どちらかのファイルが見つからない場合はエラーメッセージを出して終了。

### Step 2: レビュー内容の分析

1. **レビューレポートを読む** - 全文を精読
2. **総合評価を確認** - A / B / C / D
3. **改善提案を抽出** - 必須・推奨・検討の3カテゴリに分類
4. **元の計画を読む** - 反映対象の計画書を全文読み込み

### Step 3: 必須指摘の自動反映

**「必須（実装前に対処すべき）」の指摘は自動で計画に反映する。**

反映の原則:
- **計画のStep/セクションを直接修正する**（コードブロック内のコード修正、説明文の追記、Stepの削除・追加）
- **修正理由をコメントとして残さない** - 計画自体をクリーンに保つ
- **大幅な構造変更が必要な場合** - 該当Stepを書き換え、ファイル一覧や検証方法も更新する
- **削除すべきStep** - Stepを削除し、後続のStep番号を振り直す
- **新規Stepが必要な場合** - 適切な位置に挿入し、番号を振り直す

各必須指摘について:
1. レビューの「指摘事項」と「推奨対応」を確認
2. 計画内の該当箇所を特定
3. 推奨対応に基づいて計画を修正
4. 修正の影響を受ける他のセクション（ファイル一覧、検証方法等）も整合性を取る

### Step 4: 推奨・検討の確認

必須指摘の反映が完了したら、「推奨」と「検討」の指摘をユーザーに提示する。

表示形式:
```
## 推奨指摘（対応が望ましい）

1. **{指摘事項}**
   推奨対応: {推奨対応}

2. ...

## 検討指摘（余裕があれば）

1. **{指摘事項}**
   推奨対応: {推奨対応}

2. ...

反映する項目を番号で指定してください（例: 推奨1,2 検討1）
すべてスキップする場合は「なし」と入力してください。
```

ユーザーが選択した項目のみ計画に反映する。

### Step 5: レビューステータスの更新

計画の修正が完了したら、レビューファイルの冒頭に反映ステータスを追記する。

```markdown
> **反映ステータス**: 反映済み（YYYY-MM-DD）
> **反映内容**: 必須 {N}件 + 推奨 {N}件 + 検討 {N}件
```

### Step 6: 結果の報告

修正内容のサマリーをユーザーに報告する:
- 反映した指摘の件数（必須 / 推奨 / 検討）
- 主な変更内容の要約（3-5行）
- 修正後の計画ファイルのパス
- 必要に応じて再レビュー（`/review-plan`）を提案

## Error Handling

| 状況 | 対応 |
|------|------|
| レビューファイルが見つからない | `/review-plan` で先にレビューを実行するよう案内 |
| 計画ファイルが見つからない | ファイルパスを確認してもらう |
| 総合評価が A | 「修正不要です」と報告して終了 |
| 指摘内容が曖昧で反映方法が不明 | ユーザーに具体的な修正方針を確認 |

## Notes

- このスキルは `/review-plan` とペアで使う想定
- 計画を修正した後、再度 `/review-plan` でレビューし、総合評価が A or B になるまで繰り返す運用を推奨
- 反映時に計画の一貫性を保つこと（Step番号、ファイル一覧、検証方法の整合性）
