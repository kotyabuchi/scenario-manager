---
name: exec-plan
description: docs/plans/配下の実装計画を実行に移す。プランのStepをTodoListに変換し、サブエージェントを活用して順次実装する。「プランを実行して」「計画を実装して」「exec-plan」で起動。
argument-hint: "[plan-file-name]"
---

# Exec Plan - 実装計画の実行

`docs/plans/` 配下のプランファイルを読み込み、各Step/Batchを TodoList に変換して順次実装する。

## When to Use

- `/review-plan` でレビュー済みの計画を実装に移したい
- 実装計画の各Stepを順番に、サブエージェントを活用して実行したい
- 大きな計画を管理しながら段階的に進めたい

## Instructions

### Step 1: 対象プランの特定

引数 `$ARGUMENTS` が指定されている場合:
- `docs/plans/` 内で一致するファイルを探す（拡張子 `.md` は省略可能）

引数がない場合:
- `docs/plans/` 内の `.md` ファイルを更新日時の降順で取得
- **最新4件をユーザーに提示し、AskUserQuestion で選択させる**

```
選択肢の表示形式:
1. {ファイル名} — {計画タイトル（# 見出し）}
2. ...
3. ...
4. ...
```

対象ファイルが見つからない場合はエラーメッセージを出して終了。

### Step 2: プランの解析

プランファイルを全文読み込み、実装単位を抽出する。

プランは `.claude/templates/plan-template.md` に従った統一フォーマットで記述されている。

**抽出ルール**:
1. `## Batch N:` 見出しを「Batch（大単位）」として抽出
2. Batch 内の `### Step N-M.` を「Step（小単位）」として抽出
3. `## Batch` で始まらない `##` 見出しはすべてスキップ（Context, 決定事項, 前提条件, ファイル一覧, 検証方法, その他補足セクション）

### Step 3: TodoList の作成

抽出した実装単位を TaskCreate で TodoList に登録する。

各タスクの形式:
- **subject**: `[Plan] {見出しテキスト}`（例: `[Plan] Batch 1: 公開ページ（認証不要）`）
- **description**: プランから抽出した該当セクションの全内容（テストケース表、コード例、ファイルパス等を含む）
- **activeForm**: `{見出しテキスト}を実装中`

Batch と Step の登録:
- **Batch**: 親タスクとして登録（概要のみ、実装内容は含めない）
- **Step**: Batch 配下の個別タスクとして登録
- Step 間は `addBlockedBy` で順序関係を設定（Step 1-1 → Step 1-2 → ...）
- Batch 間も順序関係を設定（Batch 1 の全 Step 完了 → Batch 2 開始）

**前提条件に事前実装がある場合**:
- 最初のタスクとして `[Plan] 前提実装: {内容}` を登録
- Batch 1 の最初の Step がこのタスクに依存するよう設定

### Step 4: 実装の実行

TodoList の各タスクを上から順番に実行する。

**各タスクの実行フロー**:

1. **TaskUpdate** でステータスを `in_progress` に変更
2. **タスク内容を分析**し、最適な実装方法を決定:

| タスクの内容 | 使用するサブエージェント/ツール |
|---|---|
| テストコードの作成 | `tdd-implementer` エージェント |
| UI コンポーネントの実装 | `ui-implementer` エージェント |
| 複数ファイルにまたがる実装 | `serena-expert` エージェント |
| 1-2ファイルの小さな変更 | 直接編集（サブエージェント不要） |
| E2E テストの作成 | 直接実装 + Playwright テスト実行 |
| リファクタリング | `tdd-refactorer` エージェント |

3. **サブエージェントに渡すプロンプト**には以下を含める:
   - プランの該当セクション全文
   - 関連するプロジェクトルール（CLAUDE.md の要約）
   - 前のタスクで変更したファイルの情報（依存がある場合）

4. **実装完了後**:
   - `pnpm check` で lint/format 確認
   - 必要に応じて `pnpm vitest run` でテスト実行
   - **TaskUpdate** でステータスを `completed` に変更

5. **実装に失敗した場合**:
   - エラー内容をユーザーに報告
   - タスクは `in_progress` のまま維持
   - ユーザーの指示を待つ（続行 / スキップ / 中断）

### Step 5: 完了報告

全タスク完了後、実装結果のサマリーをユーザーに報告する:

- 完了したタスク数 / 全タスク数
- 変更されたファイル一覧（`git status` で取得）
- 失敗またはスキップしたタスクがあればその内容
- **コミットは行わない** — ユーザーに `/commit` の使用を案内する

## Error Handling

| 状況 | 対応 |
|------|------|
| プランファイルが見つからない | `docs/plans/` にプランがない旨を報告 |
| プランに実装Stepが見つからない | プランの構造を確認するよう案内 |
| サブエージェントが失敗 | エラー内容を報告し、ユーザーに判断を委ねる |
| lint/テストが失敗 | 修正を試みる。3回失敗したらユーザーに報告 |
| タスク間の依存で問題発生 | 前のタスクの成果物を確認し、必要なら修正 |

## Notes

- このスキルは `/review-plan` → `/apply-plan-review` の後に使う想定
- 大きなプランは複数セッションに分けて実行可能（TodoList は永続化される）
- サブエージェントの選択は目安であり、タスク内容に応じて柔軟に判断する
- 計画のレビューが未実施の場合、先に `/review-plan` を推奨する
