# レビューUI 詳細仕様書

## 1. 概要

### 1.1 目的
シナリオ詳細ページ（/scenarios/[id]）におけるレビュー表示・投稿・管理機能の詳細仕様を定義する。

### 1.2 設計原則
- **ネタバレ保護を徹底**: 未プレイユーザーに配慮した情報開示
- **ユーザー主導の情報制御**: 非表示・表示切り替えを個人で管理
- **初見3秒ルール**: UIは直感的で操作が明確

---

## 2. レビューカードのUI構成

### 2.1 基本構造

```
┌──────────────────────────────────────────────────┐
│ [アイコン] ユーザー名             [編集] [非表示] │ ← ヘッダー（右上に操作ボタン）
│ ★★★★☆ 4.0    2024/01/15                        │ ← 評価＋日時
├──────────────────────────────────────────────────┤
│ 【公開コメント】                                  │
│ とても面白いシナリオでした！                       │
│ 推理要素が多く、プレイヤー同士で議論が盛り上がり... │
│                                                  │
│ ┌────────────────────────────────────────────┐   │
│ │ ⚠ ネタバレを含む感想を表示（クリックで展開）│   │ ← ネタバレ展開ボタン（常に表示）
│ └────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
```

### 2.2 ヘッダー部分

| 要素 | 配置 | 表示条件 |
|------|------|----------|
| ユーザーアイコン | 左端 | 常時表示 |
| ユーザー名 | アイコン右 | 常時表示 |
| 編集ボタン | 右上 | 本人のみ |
| 非表示ボタン | 右上（編集の右） | 本人以外に表示 |

**ボタン表示例**:
- 本人: `[編集]`
- 他人: `[非表示]`

### 2.3 評価＋日時

| 要素 | 表示形式 | 備考 |
|------|----------|------|
| 星評価 | ★★★★☆（1〜5） | ratingがnullの場合は「評価なし」 |
| 数値評価 | 4.0 | 星の横に表示 |
| 投稿日時 | 2024/01/15 | YYYY/MM/DD形式 |

### 2.4 公開コメント

- openCommentが存在する場合のみ表示
- 改行を保持して表示
- 最大表示行数: 10行（それ以上は「もっと見る」で展開）

### 2.5 ネタバレコメント（折りたたみ）

#### 初期状態（折りたたみ）
```
┌────────────────────────────────────────────┐
│ ⚠ ネタバレを含む感想を表示（クリックで展開）│
└────────────────────────────────────────────┘
```

#### 展開状態
```
┌────────────────────────────────────────────┐
│ ⚠ ネタバレを含む感想                        │
│ ▼ 折りたたむ                               │
├────────────────────────────────────────────┤
│ 【スポイラーコメント】                      │
│ ラスボスの正体が○○だったのは衝撃的でした... │
│                                            │
└────────────────────────────────────────────┘
```

**仕様**:
- spoilerCommentが存在する場合のみ表示
- 初期状態は折りたたみ
- クリックで展開・折りたたみを切り替え
- 展開時は背景色を少し暗くして区別

---

## 3. レビュー一覧の表示制御

### 3.1 フィルタパネル

```
┌──────────────────────────────────────────┐
│ レビュー 42件                             │
│                                          │
│ 表示: [すべて ▼] [新着順 ▼]             │
│       ├ すべて                           │
│       ├ 評価あり                         │
│       └ 非表示のみ                       │
│                                          │
│ ソート: [新着順 ▼]                       │
│        ├ 新着順                          │
│        ├ 高評価順                        │
│        └ 低評価順                        │
│                                          │
│ [非表示にしたコメントを表示]  ← トグルボタン│
└──────────────────────────────────────────┘
```

#### フィルタ項目

| フィルタ | 選択肢 | 挙動 |
|----------|--------|------|
| 表示 | すべて（デフォルト） | 全レビューを表示 |
|      | 評価あり | ratingが存在するレビューのみ |
|      | 非表示のみ | ユーザーが非表示にしたレビュー |
| ソート | 新着順（デフォルト） | created_at降順 |
|        | 高評価順 | rating降順 |
|        | 低評価順 | rating昇順 |

#### 非表示コメント表示ボタン
- デフォルト: 非表示コメントは表示しない
- トグルON: 非表示コメントも表示（カードに「非表示中」バッジ表示）

---

## 4. 非表示機能

### 4.1 非表示の動作

| 操作 | 挙動 | データ保存 |
|------|------|------------|
| [非表示]ボタンクリック | カードを即座に非表示 | localStorage（永続保存） |
| [表示]トグルON | 非表示カードを薄く表示 | - |

### 4.2 非表示カードの表示状態

```
┌──────────────────────────────────────────────────┐
│ [アイコン] ユーザー名                  [再表示]   │
│ ★★★★☆ 4.0    2024/01/15                        │
│                                                  │
│ （このコメントは非表示中）                        │
└──────────────────────────────────────────────────┘
```

**仕様**:
- カード全体を薄く表示（opacity: 0.5）
- コメント内容は表示しない
- [再表示]ボタンで非表示を解除

### 4.3 localStorage保存形式

```typescript
type HiddenReviews = {
  [scenarioId: string]: string[]; // reviewIdの配列
};

// 例
{
  "01HY5K3XABCDEFGHIJKLMNOPQR": [
    "01HY5K4XABCDEFGHIJKLMNOPQR",
    "01HY5K5XABCDEFGHIJKLMNOPQR"
  ]
}
```

---

## 5. レビュー投稿・編集

### 5.1 投稿フォーム

```
┌──────────────────────────────────────────┐
│ レビューを投稿                            │
├──────────────────────────────────────────┤
│ 評価: ☆☆☆☆☆ （任意）                    │
│                                          │
│ 公開コメント（ネタバレなし）:             │
│ ┌──────────────────────────────────────┐ │
│ │                                      │ │
│ └──────────────────────────────────────┘ │
│ ※ 誰でも閲覧できる内容を書いてください    │
│                                          │
│ ネタバレを含む感想:                       │
│ ┌──────────────────────────────────────┐ │
│ │                                      │ │
│ └──────────────────────────────────────┘ │
│ ※ 折りたたみ表示されます                 │
│                                          │
│ [投稿する]  [キャンセル]                 │
└──────────────────────────────────────────┘
```

### 5.2 投稿条件

| 条件 | 説明 |
|------|------|
| 参加済みセッション | sessionPhase = COMPLETED |
| 1シナリオ1レビュー | ユニーク制約（userId + scenarioId） |
| 最小入力 | rating, openComment, spoilerCommentすべて任意 |

### 5.3 バリデーション

| フィールド | ルール |
|-----------|--------|
| rating | 1〜5の整数、または未入力（null） |
| openComment | 最大2000文字 |
| spoilerComment | 最大2000文字 |

---

## 6. 編集機能

### 6.1 編集ボタン配置
- カード右上に[編集]ボタン表示（本人のみ）
- クリックで編集フォームに遷移

### 6.2 編集フォーム
投稿フォームと同一形式。現在の内容を初期値として表示。

### 6.3 削除機能
編集画面に[削除]ボタンを配置（確認ダイアログ表示）。

---

## 7. ユーザーストーリー（補足）

```
US-411: ユーザーとして、他人のレビューを非表示にできる
US-412: ユーザーとして、非表示にしたレビューを再表示できる
US-413: ユーザーとして、非表示のレビュー一覧を確認できる
US-414: レビュー投稿者として、評価なしでもコメントのみ投稿できる
US-415: ユーザーとして、ネタバレコメントを展開して閲覧できる
US-416: ユーザーとして、レビューを高評価順・低評価順でソートできる
```

---

## 8. 実装指示

1. **ネタバレ展開ボタンはネタバレコメント部分に統合する**
2. **編集・非表示ボタンはカード右上に配置**
3. **非表示機能はlocalStorageで永続保存**
4. **非表示コメント表示ボタンはフィルタパネルに配置**
5. **ソートUIはフィルタパネル形式**
6. **初期状態はネタバレコメント折りたたみ**
7. **非表示カードは薄く表示し、コメント内容は非表示**

---

## 9. 次のトピック（予告）

- 動画リンクの表示形式（Spoiler機能含む）
- 振り返りシーン向けの要素（セッション詳細ページとの連携）
