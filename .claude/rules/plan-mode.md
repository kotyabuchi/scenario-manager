# Plan Mode（プランモード）

## 概要

Boris Cherny（Claude Code作成者）推奨のプラクティス。
複雑なタスクでは計画段階に注力し、一度で正しく実装できるようにする。

> "Plan more than you think you need to. A good rule of thumb is: if the change touches 3+ files or 100+ lines, spend 5–10 minutes planning first."

## 使用トリガー（いつ使うか）

以下のいずれかに該当する場合、`Plan`エージェントを使用する：

| 条件 | 例 |
|------|-----|
| 100行以上のコード変更が予想される | 新規機能の追加 |
| 3ファイル以上にまたがる変更 | リファクタリング、横断的関心事 |
| アーキテクチャに影響する変更 | 新規パターン導入、データフロー変更 |
| 複数の実装アプローチが考えられる | ライブラリ選定、設計判断 |
| 要件が曖昧で整理が必要 | ユーザー要望の具体化 |

## 使用しない場合

- 1ファイル完結の小さな修正（typo、軽微なバグ）
- 既存パターンの再利用（コピペで対応可能）
- 明確なバグ修正（`/fix-bug`スキルを使用）
- 単純なスタイル調整

## Planエージェントの使い方

```
「この機能の実装計画を立てて」
「Plan エージェントで設計を検討して」
```

Planエージェントは以下を実行する：
1. 関連ファイルの探索（Glob, Grep, Read）
2. 既存パターンの分析
3. 実装ステップの設計
4. 影響範囲の特定
5. `.claude/templates/plan-template.md` のフォーマットに従って `docs/plans/` に計画書を作成

## 検証者パターン（推奨）

複雑な変更では「検証者」として別セッションを活用する：

1. **メインセッション**: Planエージェントに計画を立てさせる
2. **別セッション**: 計画をレビューさせる
   - 「この計画に問題はないか？」
   - 「見落としている影響範囲は？」
3. **メインセッション**: レビュー結果を元に計画を修正

この「二人目の目」により、単一セッションでは見落としがちな問題を発見できる。

## TDDワークフローとの統合

```
/requirements → [Plan] → /pencil-design → レビュー → /gen-test → ...
        ↑
   複雑な機能のみ
```

**使い分け**:
- 単純な機能: `/requirements` → `/pencil-design` → 直接TDD
- 複雑な機能: `/requirements` → `Plan` → `/pencil-design` → TDD

Planエージェントを挟むことで：
- 要件の抜け漏れを発見
- 実装アプローチを事前に検討
- デザイン前に技術的制約を明確化

## 計画書のフォーマット（必須）

**テンプレート**: `.claude/templates/plan-template.md`
**出力先**: `docs/plans/{機能名}.md`

### 構造ルール

| セクション | 必須 | 見出しレベル | 備考 |
|-----------|:----:|:-----------:|------|
| Context | `##` | 必須 | 背景・目的 |
| 決定事項 | `##` | 必須 | 表形式で技術選定・設計判断を記載 |
| 前提条件 | `##` | 必須 | 不要なら「なし」と記載 |
| Batch N: {名前} | `##` | 必須 | 実装の大単位。最低1つ |
| Step N-M. {名前} | `###` | 必須 | Batch 内の実装ステップ |
| ファイル一覧 | `##` | 必須 | 新規・変更ファイルを表で記載 |
| 検証方法 | `##` | 必須 | 自動テスト・手動テストの手順 |

### 命名規則

- **Batch**: `## Batch {N}: {名前}` — 実装の大単位（順序実行）
- **Step**: `### Step {N}-{M}. {名前}` — Batch 内の実装ステップ
  - N = Batch 番号、M = Batch 内の連番
- 小規模な計画（5ステップ以下）でも Batch 1 として記述する

### 非実装セクション

Context、決定事項、前提条件、ファイル一覧、検証方法は `/exec-plan` 実行時にスキップされる。
これら以外の補足セクション（法的リスク、UIフロー等）は `## ` 見出しで自由に追加可能だが、
`Batch` / `Step` の命名パターンと衝突しないこと。

---

## 計画後のレビュープロセス（推奨）

複雑な変更では、計画を立てた後に別セッションでレビューを実施する。

### 手順

1. **レビューファイル作成**
   - 計画の要約、リスク分析、レビュー観点を `.claude/reviews/` に書き出す
   - ファイル名: `{機能名}-plan.md`

2. **レビュー用プロンプト作成**
   - 別セッションで使用するプロンプトを作成
   - ファイル名: `{機能名}-review-prompt.md`

3. **レビュー実施**
   - 別のClaudeセッション（検証者）でプロンプトを実行
   - レビュー結果を確認

4. **計画修正**
   - レビュー結果に基づいて計画を修正
   - 必須の修正事項がなくなるまで繰り返す

### レビュー観点テンプレート

- [ ] 技術的妥当性
- [ ] 移行/実装アプローチの適切さ
- [ ] 影響範囲の網羅性
- [ ] 工数見積もりの妥当性
- [ ] 代替案の検討

### 目的

Boris Cherny推奨の「検証者パターン」により、単一セッションでは見落としがちな問題を発見する。
