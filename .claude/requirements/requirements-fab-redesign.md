# FABリニューアル 要件定義書

**作成日**: 2026-02-13
**TDDフェーズ**: 要件定義

---

## 1. 概要

### 1.1 目的

画面右下のFAB（Floating Action Button）を単機能（フィードバックのみ）からSpeed Dialパターンの多機能メニューに刷新し、主要アクションへのクイックアクセスを提供する。

### 1.2 対象ユーザー

- **田中さん（週末GM）**: セッション募集・シナリオ登録を素早く行いたい
- **鈴木さん（新人PL）**: シナリオをすぐに検索したい
- **全ユーザー**: どのページからでもフィードバックを送りたい

### 1.3 ユーザーストーリー

- 「GMとして、シナリオ詳細を見ている最中にセッション募集を思い立ったので、その場からすぐ募集画面に行きたい」
- 「シナリオ名を思い出したので、今いるページから離れずにすぐ検索して詳細を確認したい」
- 「友達にこのページを共有したいので、URLを素早くコピーしたい」

---

## 2. 機能要件

### 2.1 メニュー項目

#### 認証済みユーザー（5項目）

| # | 項目 | アイコン | アクション | 認証 |
|---|------|---------|----------|------|
| 1 | シナリオ登録 | `BookOpenText` | ScenarioRegisterDialog表示（手動/インポート選択） | 必須 |
| 2 | セッション募集 | `CalendarPlus` | `/sessions/new` へ遷移 | 必須 |
| 3 | シナリオ検索 | `MagnifyingGlass` | 検索モーダル表示 | 不要 |
| 4 | シェア | `ShareNetwork` | URLコピー / Web Share API | 不要 |
| 5 | フィードバック | `ChatText` | FeedbackModal表示 | 必須 |

#### 未認証ユーザー（3項目）

| # | 項目 | アイコン | アクション |
|---|------|---------|----------|
| 1 | シナリオ検索 | `MagnifyingGlass` | 検索モーダル表示 |
| 2 | シェア | `ShareNetwork` | URLコピー / Web Share API |
| 3 | ログイン | `SignIn` | ログインページへ遷移 |

### 2.2 Speed Dial パターン

#### 展開動作
- FABボタンタップ → メニュー項目がFAB上方に縦リストで展開
- 各項目はアイコン + ラベルテキストで構成
- 展開時、FABアイコンが `Plus` → `X`（閉じる）にアニメーション遷移
- 認証済みメニュー: アクション系（登録・募集・検索）とユーティリティ系（シェア・フィードバック）をディバイダーで視覚的に分離
- 未認証メニュー: 3項目のためディバイダーなし

#### 閉じ動作
- FABボタン再タップ
- メニュー項目タップ（アクション実行後に閉じる）
- オーバーレイ（背景）タップ
- Escapeキー押下

#### オーバーレイ
- メニュー展開時、背景に半透明オーバーレイを表示
- オーバーレイタップでメニューを閉じる

### 2.3 シナリオ検索（クイック検索）

- シナリオ名のインクリメンタルサーチ
- 入力欄 + 結果リスト（最大5件）をモーダル/ポップオーバーで表示
- 結果タップ → `/scenarios/[id]` へ遷移
- 検索対象: `scenarios` テーブルの `title` カラム
- デバウンス: 300ms
- 0件時: 「見つかりませんでした」表示
- 「すべての結果を見る」リンク → `/scenarios?q=検索語` へ遷移

### 2.4 シェア機能

- **デスクトップ**: 現在のページURLをクリップボードにコピー → トースト「URLをコピーしました」
- **モバイル（Web Share API対応）**: OS標準の共有シートを表示
- **モバイル（Web Share API非対応）**: デスクトップと同じ挙動にフォールバック
- 共有データ: `{ title: document.title, url: location.href }`

### 2.5 シナリオ登録

- 既存の `ScenarioRegisterDialog` を再利用
- 2つの選択肢を表示:
  - 「手動で入力」→ `/scenarios/new`
  - 「URLからインポート」→ `/scenarios/import`

### 2.6 セッション募集

- `/sessions/new` へページ遷移

### 2.7 フィードバック

- 既存の `FeedbackModal` を再利用
- 動作は現行と同一

---

## 3. レスポンシブ対応

### 3.1 デスクトップ（md以上: 768px〜）

- FABは画面右下に固定配置（`position: fixed`）
- `bottom: 32px`, `right: 32px`
- Speed Dialメニューは上方向に展開

### 3.2 モバイル（md未満: 〜768px）

- **BottomNavの中央FABを新FABに置換**
- 現在の `Plus` アイコン（シナリオ登録直リンク）→ Speed Dialメニューに変更
- BottomNav内に組み込まれた形で表示
- メニュー展開時はBottomNavの上方にオーバーレイ付きで展開
- BottomNavのセーフエリア（safe-area-inset-bottom）対応を維持

### 3.3 既存FABの廃止

| 廃止対象 | 代替 |
|---------|------|
| `FeedbackButton`（グローバル） | 新FABのフィードバック項目 |
| `ScenarioFAB`（シナリオ詳細ページ） | 新FABに統合。プレイ済み登録・シナリオ編集はページ内UIへ移設 |
| `BottomNav` 中央FAB | 新FABに置換 |

### 3.4 ScenarioFAB廃止に伴う移設

ScenarioFABにあった以下の機能はシナリオ詳細ページ内のUIに移設する:

| 機能 | 移設先 |
|------|--------|
| セッション作成 | 新FAB「セッション募集」で代替 |
| プレイ済み登録 | シナリオ詳細ページ内のインラインボタン |
| シェア | 新FAB「シェア」で代替 |
| シナリオ編集 | シナリオ詳細ページ内のインラインボタン |

**Note**: プレイ済み登録・シナリオ編集のページ内UI移設は本要件のスコープ外。別タスクで対応。

---

## 4. アクセシビリティ

### 4.1 キーボード操作

| キー | 動作 |
|------|------|
| Enter / Space | FAB展開/閉じ、メニュー項目実行 |
| Escape | メニューを閉じる |
| Tab | メニュー項目間のフォーカス移動 |
| Shift+Tab | 逆順フォーカス移動 |

### 4.2 ARIA属性

- FABボタン: `aria-label="メニューを開く"` / `aria-expanded`
- メニュー: `role="menu"`
- メニュー項目: `role="menuitem"`
- オーバーレイ: `aria-hidden="true"`

### 4.3 フォーカス管理

- メニュー展開時、最初のメニュー項目にフォーカス
- メニュー閉じ時、FABボタンにフォーカスを戻す
- フォーカストラップ: メニュー展開中はメニュー内でフォーカスをループ

---

## 5. アニメーション

### 5.1 メニュー展開

- 各メニュー項目が下から順にスタガー（stagger）で出現
- アニメーション: `opacity: 0 → 1`, `translateY: 16px → 0`
- 持続時間: 各項目150ms、スタガー間隔50ms
- イージング: `ease-out`

### 5.2 FABアイコン回転

- 展開時: `Plus` → 45度回転して `X` に変化（`rotate(45deg)`）
- 閉じ時: 逆回転で元に戻る
- 持続時間: 200ms

### 5.3 オーバーレイ

- フェードイン/アウト: `opacity: 0 → 1`
- 持続時間: 200ms

---

## 6. TRPG固有の考慮事項

### 6.1 ネタバレ保護

- クイック検索の結果にはシナリオのネタバレ情報を含めない
- 表示項目: シナリオ名、システム名、サムネイル画像のみ

### 6.2 コンテキスト依存性なし

- 全ページで同一メニュー（ページ固有項目なし）
- シンプルさと一貫性を優先

---

## 7. テスト観点（/gen-test への引き継ぎ）

### 7.1 正常系

- [ ] FABクリックでメニューが展開される
- [ ] 各メニュー項目タップで正しいアクションが実行される
- [ ] 認証済みユーザーに5項目が表示される
- [ ] メニュー外タップで閉じる
- [ ] Escapeキーで閉じる
- [ ] シナリオ検索: 文字入力で結果が表示される
- [ ] シナリオ検索: 結果タップでシナリオ詳細に遷移する
- [ ] シェア（デスクトップ）: URLがクリップボードにコピーされる
- [ ] シナリオ登録: ダイアログが表示される
- [ ] セッション募集: `/sessions/new` に遷移する
- [ ] フィードバック: FeedbackModalが表示される

### 7.2 認証・権限

- [ ] 未認証ユーザーに3項目（検索、シェア、ログイン）が表示される
- [ ] 未認証ユーザーにシナリオ登録・セッション募集・フィードバックが表示されない
- [ ] ログインボタンタップでログインページに遷移する

### 7.3 レスポンシブ

- [ ] デスクトップ: 右下に固定FABが表示される
- [ ] モバイル: BottomNav中央にFABが表示される
- [ ] モバイル: Speed Dialがオーバーレイ付きで展開される

### 7.4 アクセシビリティ

- [ ] Tab/Shift+Tabでメニュー項目間を移動できる
- [ ] Enter/Spaceでメニュー項目を実行できる
- [ ] `aria-expanded`が展開状態に応じて変化する

### 7.5 異常系・エッジケース

- [ ] シナリオ検索: 0件時に「見つかりませんでした」が表示される
- [ ] シナリオ検索: 空文字列では検索が実行されない
- [ ] シェア: Web Share API非対応時にフォールバックが動作する
- [ ] メニュー展開中にページ遷移した場合、メニューが閉じる

---

## 8. 実装の優先度

### 8.1 MVP（必須）

- Speed Dial FABコンポーネント
- 5項目のメニュー（認証状態による出し分け）
- シナリオ登録（既存ダイアログ再利用）
- セッション募集（ページ遷移）
- フィードバック（既存モーダル再利用）
- シェア（URLコピー + Web Share API）
- デスクトップ/モバイル両対応
- FeedbackButton廃止
- BottomNav中央FAB置換

### 8.2 Phase 2

- クイック検索（インクリメンタルサーチ）
- ScenarioFAB廃止 + ページ内UI移設

### 8.3 Nice to Have（後回し可）

- アニメーションのスタガー演出
- キーボードショートカット（Cmd+K で検索起動等）
- メニュー項目の並び替え設定

---

## 9. 未決定事項

- [ ] クイック検索のAPI設計（既存の検索adapter再利用 or 専用のlightweight API）
- [ ] クイック検索モーダルのデザイン詳細（Cmd+Kパレット型 or 小さなポップオーバー型）

---

## 10. 影響範囲

### 10.1 廃止するコンポーネント

| コンポーネント | ファイルパス |
|--------------|------------|
| FeedbackButton | `src/components/blocks/FeedbackButton/` |
| ScenarioFAB | `src/app/(main)/scenarios/[id]/_components/ScenarioFAB.tsx` |

### 10.2 変更するコンポーネント

| コンポーネント | 変更内容 |
|--------------|---------|
| BottomNav | 中央FABを新SpeedDialFABに置換 |
| MainLayout | FeedbackButton → SpeedDialFAB に差し替え |

### 10.3 新規コンポーネント

| コンポーネント | ファイルパス（想定） |
|--------------|-------------------|
| SpeedDialFAB | `src/components/blocks/SpeedDialFAB/` |
| QuickSearchModal | `src/components/blocks/QuickSearchModal/`（Phase 2） |

---

## 11. TDD対象一覧

| 対象 | 種別 | ファイルパス（想定） | Phase |
|------|------|-------------------|-------|
| SpeedDialFAB | コンポーネント | `src/components/blocks/SpeedDialFAB/SpeedDialFAB.tsx` | MVP |
| SpeedDialFAB (styles) | スタイル | `src/components/blocks/SpeedDialFAB/styles.ts` | MVP |
| useSpeedDial | カスタムフック | `src/components/blocks/SpeedDialFAB/useSpeedDial.ts` | MVP |
| BottomNav (変更) | コンポーネント | `src/components/blocks/BottomNav/BottomNav.tsx` | MVP |
| QuickSearchModal | コンポーネント | `src/components/blocks/QuickSearchModal/QuickSearchModal.tsx` | Phase 2 |
| searchScenariosQuick | adapter関数 | `src/app/(main)/scenarios/adapter.ts` | Phase 2 |
