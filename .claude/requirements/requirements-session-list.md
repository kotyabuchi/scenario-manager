# セッション一覧ページ（/sessions）要件定義書

**作成日**: 2026-01-27
**TDDフェーズ**: 要件定義
**ベース**: requirements-v1.md セクション11、requirements-session-flow.md、既存実装

---

## 1. 概要

### 1.1 目的

ユーザーが自分の参加セッションを管理し、新しい公開セッションを発見できるページ。

**解決する課題**:
- 「今週のセッションいつだっけ？」→ 参加予定の確認
- 「前にやったあのセッションどうだったっけ？」→ 参加履歴の振り返り
- 「週末遊べる卓ないかな？」→ 公開卓の検索
- GMとして立てたセッションの進行管理

### 1.2 対象ユーザー

| ペルソナ | 主な利用シーン |
|----------|---------------|
| 田中さん（週末GM） | セッション管理、公開卓の作成・管理 |
| 鈴木さん（新人PL） | 公開卓を探して参加申請 |
| 佐藤さん（配信者） | 過去セッションの振り返り、動画との紐付け確認 |
| 山田さん（ベテランKP） | 複数セッションの一括管理 |

### 1.3 ユーザーストーリー

```
US-701: ユーザーとして、参加予定のセッション一覧を確認できる
US-702: ユーザーとして、参加予定をカレンダー形式で確認できる
US-703: ユーザーとして、参加履歴を確認できる
US-704: ユーザーとして、参加履歴を役割（GM/PL）でフィルタできる
US-705: ユーザーとして、公開セッションを検索できる
US-706: ユーザーとして、システムで公開セッションを絞り込める
US-707: ユーザーとして、開催日で公開セッションを絞り込める
US-708: ユーザーとして、シナリオ名で公開セッションを検索できる
US-709: ユーザーとして、セッション一覧から詳細ページに遷移できる
US-710: ユーザーとして、セッション一覧からセッションを作成できる
US-711: 未ログインユーザーとして、公開セッション一覧を閲覧できる
US-712: ユーザーとして、検索条件をURLで共有できる
```

---

## 2. 機能要件

### 2.1 タブ構成

| タブ | 表示条件 | 説明 |
|------|----------|------|
| 参加予定 | ログイン必須 | 今後参加予定のセッション（RECRUITING〜IN_PROGRESS） |
| 参加履歴 | ログイン必須 | 完了・キャンセル済みセッション（COMPLETED, CANCELLED） |
| 公開卓を探す | 全員 | 参加可能な公開セッション（デフォルトタブ） |

### 2.2 参加予定タブ

#### 表示対象
自分が参加者（GM含む）として登録されているセッションで、以下のフェーズのもの:

| フェーズ | 表示 | 説明 |
|----------|------|------|
| RECRUITING | ○ | 募集中（日程未確定の可能性あり） |
| PREPARATION | ○ | 準備中（日程確定済み） |
| IN_PROGRESS | ○ | 進行中 |
| COMPLETED | - | 履歴タブへ |
| CANCELLED | - | 履歴タブへ |

#### 表示形式切替
| 形式 | 説明 |
|------|------|
| リスト | カード形式の一覧（デフォルト） |
| カレンダー | 月間カレンダー + 右サイドパネル（セッション一覧） |

#### 表示切替アニメーション

デフォルトはリストビュー。カレンダーに切り替えると、リストが縮小しながら右サイドパネルに移動するアニメーションを実行する。これにより、右サイドパネルの内容がリストと同一であることをユーザーが直感的に理解できる。

| 遷移 | アニメーション | 説明 |
|------|--------------|------|
| リスト → カレンダー | リストが縮小 → 右に移動 → サイドパネルに収まる | カレンダーが左から展開 |
| カレンダー → リスト | サイドパネルが拡大 → 左に移動 → リストに展開 | カレンダーが縮小して消える |

**サイドパネル仕様**:
- カレンダービューの右側に配置（幅320px）
- 日程未確定セッション: dividerで区切って上部に表示（黄色背景カード）
- 選択日セッション: divider下に該当日のセッションを表示
- パネル開閉: パネル内ヘッダーに閉じるボタン、閉じた状態はアイコンのみ表示

#### カード表示情報
| 項目 | 表示例 | 優先度 |
|------|--------|--------|
| セッション日時 | 2026/01/25（土）19:00〜 | 必須 |
| シナリオ名 | 「狂気山脈」 | 必須 |
| システム名 | CoC7版 | 必須 |
| GM名 | GM: 田中太郎 | 必須 |
| フェーズバッジ | 募集中 / 準備中 / 進行中 | 必須 |
| 参加者数 | 3/4人 | 高 |
| 自分の役割 | GM / PL / 観戦 | 高 |

**日時未確定の場合**: 「日程調整中」と表示

#### カレンダー表示
| 要素 | 説明 |
|------|------|
| 表示形式 | 月間カレンダー + 右サイドパネル |
| セッション表示 | 該当日にドット/ラベル表示 |
| 日付クリック時 | 右サイドパネルに該当日のセッション一覧を表示 |
| 日程未確定 | 右サイドパネル上部にdividerで区切って表示（黄色背景カード） |
| サイドパネル開閉 | パネル内ヘッダーの閉じるボタンで開閉。閉じた状態はアイコンのみ |

#### ソートオプション
| オプション | 説明 | デフォルト |
|------------|------|------------|
| date_asc | 開催日順（近い順） | ○ |
| created_desc | 登録日順（新しい順） | - |

### 2.3 参加履歴タブ

#### 表示対象
| フェーズ | 表示 | 説明 |
|----------|------|------|
| COMPLETED | ○ | 完了 |
| CANCELLED | ○ | キャンセル（別バッジ表示） |

#### カード表示情報
| 項目 | 表示例 | 優先度 |
|------|--------|--------|
| セッション日時 | 2025/12/20（土） | 必須 |
| シナリオ名 | 「狂気山脈」 | 必須 |
| システム名 | CoC7版 | 必須 |
| GM名 | GM: 田中太郎 | 必須 |
| 完了/キャンセルバッジ | 完了 / キャンセル | 必須 |
| 参加者数 | 4人 | 中 |
| 自分の役割 | GM / PL / 観戦 | 中 |
| レビュー済みマーク | レビュー済み | 中 |
| 動画登録マーク | 動画あり | 中 |

#### フィルタ条件
| 条件 | 選択肢 | タイプ |
|------|--------|--------|
| 役割 | keeper / player / spectator | マルチセレクト |
| ステータス | completed / cancelled | マルチセレクト |
| システム | 全システムから選択 | マルチセレクト |

#### ソートオプション
| オプション | 説明 | デフォルト |
|------------|------|------------|
| date_desc | 開催日順（新しい順） | ○ |
| date_asc | 開催日順（古い順） | - |

### 2.4 公開卓を探すタブ

#### 表示対象
| フェーズ | デフォルト | フィルタ拡張 |
|----------|------------|--------------|
| RECRUITING | ○ | - |
| PREPARATION | ○ | - |
| IN_PROGRESS | - | ○ |
| COMPLETED | - | ○ |
| CANCELLED | - | - |

#### 検索条件
| 条件 | 入力形式 | デフォルト | 絞り込み挙動 |
|------|----------|------------|--------------|
| システム | マルチセレクト | 指定なし（全システム） | OR条件 |
| 開催日範囲 | 日付入力（from/to） | 指定なし | 範囲内 |
| フェーズ | マルチセレクト | 募集中+準備中 | OR条件 |
| シナリオ名 | テキスト | 空 | 部分一致（大文字小文字無視） |

#### カード表示情報
| 項目 | 表示例 | 優先度 |
|------|--------|--------|
| セッション日時 | 2026/01/25（土）19:00〜 | 必須 |
| シナリオ名 | 「狂気山脈」 | 必須 |
| システム名 | CoC7版 | 必須 |
| GM名 | GM: 田中太郎 | 必須 |
| フェーズバッジ | 募集中 / 準備中 | 必須 |
| 募集人数 | 3/4人 | 必須 |
| 残り枠警告 | 残り1枠（3/4） | 条件付き |
| プレイ時間目安 | 約4-6時間 | 中 |

**残り枠警告の表示条件**: 残り人数が最大人数の3割以下になった場合、赤色の「残りN枠」バッジを表示する。
- 例: 最大4人で3人参加済み → 残り1枠（3割以下） → 赤バッジ表示
- 例: 最大4人で2人参加済み → 残り2枠（50%） → 通常表示

#### ソートオプション
| オプション | 説明 | デフォルト |
|------------|------|------------|
| date_asc | 開催日順（近い順） | ○ |
| created_desc | 新着順 | - |
| slots_desc | 残り枠順（空き枠の多い順） | - |

#### ネタバレ保護
| 要素 | 表示 | 理由 |
|------|------|------|
| シナリオ名 | ○ | 参加判断に必要 |
| システム名 | ○ | 参加判断に必要 |
| GM名 | ○ | 参加判断に必要 |
| 開催日時 | ○ | 参加判断に必要 |
| プレイ人数/時間 | ○ | 判断に必要 |
| シナリオサムネイル | ✕ | ネタバレの可能性 |
| シナリオ概要 | ✕ | ネタバレの可能性 |
| タグ | ✕ | ネタバレの可能性 |
| レビュー | ✕ | ネタバレの可能性 |

### 2.5 全体レイアウト

```
┌─────────────────────────────────────────────────────┐
│ セッション                      [+ セッション作成]  │ ← ヘッダー
├─────────────────────────────────────────────────────┤
│ [参加予定] [参加履歴] [公開卓を探す]               │ ← タブ
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ フィルタ・検索エリア                           │ │
│ └─────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ [リスト] [カレンダー]  ← 表示切替（参加予定のみ）   │
├─────────────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐               │
│ │ Card    │ │ Card    │ │ Card    │               │
│ └─────────┘ └─────────┘ └─────────┘               │
│                                                     │
│ [もっと見る]                                        │
└─────────────────────────────────────────────────────┘
```

---

## 3. データ項目

### 3.1 URLパラメータ（searchParams.ts）

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|------------|------|
| tab | 'upcoming' \| 'history' \| 'public' | 'public' | アクティブタブ |
| view | 'list' \| 'calendar' | 'list' | 表示形式（参加予定のみ） |
| upcomingSort | 'date_asc' \| 'created_desc' | 'date_asc' | 参加予定ソート |
| historySort | 'date_desc' \| 'date_asc' | 'date_desc' | 履歴ソート |
| publicSort | 'date_asc' \| 'created_desc' \| 'slots_desc' | 'date_asc' | 公開卓ソート |
| systems | string[] | [] | システムID（公開卓） |
| phases | string[] | ['RECRUITING', 'PREPARATION'] | フェーズ（公開卓） |
| dateFrom | string \| null | null | 開催日開始（公開卓） |
| dateTo | string \| null | null | 開催日終了（公開卓） |
| q | string | '' | シナリオ名検索（公開卓） |
| roles | string[] | [] | 役割フィルタ（履歴） |
| statuses | string[] | [] | ステータスフィルタ（履歴） |
| historySystems | string[] | [] | システムフィルタ（履歴） |

### 3.2 検索フォームスキーマ（schema.ts）

```typescript
const searchFormSchema = z.object({
  systems: z.array(z.string()),
  phases: z.array(z.string()),
  dateFrom: z.string().optional(),
  dateTo: z.string().optional(),
  q: z.string(),
}).refine((data) => {
  // 終了日のみが入力されている場合はエラー
  if (!data.dateFrom && data.dateTo) return false;
  // 開始日が終了日より後の場合はエラー
  if (data.dateFrom && data.dateTo && data.dateFrom > data.dateTo) return false;
  return true;
}, {
  message: '開催日の範囲が正しくありません',
  path: ['dateFrom'],
});
```

### 3.3 型定義（interface.ts）

| 型名 | 説明 |
|------|------|
| TabType | 'upcoming' \| 'history' \| 'public' |
| ViewType | 'list' \| 'calendar' |
| SessionPhase | 'RECRUITING' \| 'PREPARATION' \| 'IN_PROGRESS' \| 'COMPLETED' \| 'CANCELLED' |
| PublicSession | 公開卓用のセッション情報（ネタバレ保護済み） |
| MySessionWithRole | 自分のセッション（役割付き） |
| CalendarData | カレンダー用データ（日程確定/未確定セッション） |
| SearchResult<T> | 検索結果（sessions + totalCount） |

---

## 4. 権限制御

| 機能 | 未ログイン | MEMBER | MODERATOR |
|------|-----------|--------|-----------|
| 公開卓を探すタブ閲覧 | ○ | ○ | ○ |
| 参加予定タブ閲覧 | - | ○ | ○ |
| 参加履歴タブ閲覧 | - | ○ | ○ |
| セッション作成ボタン | 非表示 | ○ | ○ |
| セッション参加申請 | - | ○ | ○ |
| カレンダー表示 | - | ○ | ○ |

**未ログイン時の挙動**:
- 「参加予定」「参加履歴」タブはdisabled
- クリック時: 「ログインが必要です」メッセージ + ログインボタン表示
- デフォルトで「公開卓を探す」タブを表示
- セッション作成ボタンは非表示

---

## 5. TRPGセッション固有の考慮事項

### 5.1 ネタバレ保護

公開卓一覧では、未プレイユーザーへのネタバレを防ぐため、シナリオの詳細情報（サムネイル、概要、タグ、レビュー）は表示しない。

シナリオ詳細を確認したい場合は、別途「シナリオ詳細を見る」リンクから遷移する。

### 5.2 荒らし対策

- セッション作成・参加申請はログインユーザーのみ
- 悪意のあるセッションはMODERATORが削除可能（将来実装）

### 5.3 日程調整との連携

- 日程未確定セッションは「日程調整中」と表示
- カレンダービューでは「日程未確定」セクションに別途表示
- requirements-session-flow.md のフローに準拠

---

## 6. テスト観点（/gen-test への引き継ぎ）

### 6.1 adapter関数

#### searchPublicSessions

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-PS-001 | 条件なしで検索 | 募集中+準備中のセッションを返す |
| T-PS-002 | システムIDでフィルタ | 指定システムのセッションのみ返す |
| T-PS-003 | シナリオ名で検索 | 部分一致するセッションを返す |
| T-PS-004 | 日付範囲でフィルタ | 範囲内のセッションのみ返す |
| T-PS-005 | ソートオプション適用 | 指定順でソートされる |
| T-PS-006 | ページネーション | limit/offsetが正しく動作 |
| T-PS-007 | 0件時 | 空配列とtotalCount=0を返す |

#### getUpcomingSessions

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-US-001 | 存在しないユーザーID | 空配列を返す |
| T-US-002 | 存在するユーザー | 参加予定セッションを返す |
| T-US-003 | myRoleが含まれる | KEEPER/PLAYER/SPECTATORのいずれか |
| T-US-004 | ソートオプション適用 | 指定順でソートされる |
| T-US-005 | 完了/キャンセル済みは除外 | RECRUITING/PREPARATION/IN_PROGRESSのみ |

#### getHistorySessions

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-HS-001 | 存在しないユーザーID | 空配列を返す |
| T-HS-002 | 存在するユーザー | 履歴セッションを返す |
| T-HS-003 | 役割でフィルタ | 指定役割のセッションのみ返す |
| T-HS-004 | ステータスでフィルタ | 指定ステータスのセッションのみ返す |
| T-HS-005 | システムでフィルタ | 指定システムのセッションのみ返す |
| T-HS-006 | isReviewed/hasVideo含む | メタ情報が付与される |

#### getCalendarSessions

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-CS-001 | 存在しないユーザーID | 空の sessions/unscheduledSessions |
| T-CS-002 | 指定月のセッション取得 | 月内のセッションを返す |
| T-CS-003 | 日程確定/未確定の分離 | 別配列で返される |
| T-CS-004 | 必要情報が含まれる | gameSessionId, sessionName, scenarioName, scheduleDate, myRole |

### 6.2 Zodスキーマ（searchFormSchema）

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-SF-001 | 全項目空 | バリデーション成功 |
| T-SF-002 | dateToのみ指定 | バリデーション失敗 |
| T-SF-003 | dateFrom > dateTo | バリデーション失敗 |
| T-SF-004 | dateFrom <= dateTo | バリデーション成功 |
| T-SF-005 | 有効な全項目 | バリデーション成功 |

### 6.3 権限制御

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-AC-001 | 未ログイン + 公開卓タブ | 正常表示 |
| T-AC-002 | 未ログイン + 参加予定タブ | ログイン促進メッセージ |
| T-AC-003 | 未ログイン + 参加履歴タブ | ログイン促進メッセージ |
| T-AC-004 | ログイン済み + 全タブ | 正常表示 |
| T-AC-005 | 未ログイン時 | セッション作成ボタン非表示 |

### 6.4 0件時の表示

| ID | ケース | 期待結果 |
|----|--------|----------|
| T-EMP-001 | 参加予定0件 | 「参加予定のセッションはありません」+ CTAボタン |
| T-EMP-002 | 参加履歴0件 | 「参加履歴はまだありません」+ CTAボタン |
| T-EMP-003 | 公開卓検索0件 | 「条件に一致するセッションが見つかりませんでした」+ CTAボタン |

---

## 7. 実装の優先度

### 7.1 MVP（必須） - 実装済み

- [x] 3タブ構成（参加予定/参加履歴/公開卓を探す）
- [x] 公開卓検索（システム/日付/フェーズ/シナリオ名）
- [x] 参加予定一覧表示（リスト形式）
- [x] 参加履歴一覧表示（役割/ステータス/システムフィルタ）
- [x] カレンダービュー（参加予定）
- [x] セッション作成ボタン
- [x] 未ログイン時の制御
- [x] URLによる状態管理（nuqs）

### 7.2 Nice to Have（後回し可）

- [ ] カレンダービューの日付クリックでポップオーバー表示
- [ ] 残り枠順ソートの正確な実装（現在は作成日順にフォールバック）
- [ ] ページネーション（現在は20件固定）
- [ ] 無限スクロール
- [ ] 検索条件のプリセット（今週末/来週/今月）

---

## 8. 未決定事項

| 項目 | 検討内容 | 期限 |
|------|----------|------|
| ページネーション方式 | 「もっと見る」ボタン vs 無限スクロール vs ページ番号 | 次フェーズ |
| 残り枠順ソート | 正確な計算ロジック（参加者数 vs 募集人数の差分） | 次フェーズ |
| カレンダーの複数セッション表示 | ポップオーバー vs モーダル vs サイドパネル | 次フェーズ |

---

## 9. TDD対象一覧

| 対象 | 種別 | ファイルパス | 状態 |
|------|------|-------------|------|
| searchFormSchema | Zodスキーマ | `src/app/(main)/sessions/_components/schema.ts` | 実装済 |
| searchParamsParsers | nuqsパーサー | `src/app/(main)/sessions/searchParams.ts` | 実装済 |
| searchPublicSessions | adapter関数 | `src/app/(main)/sessions/adapter.ts` | 実装済 |
| getUpcomingSessions | adapter関数 | `src/app/(main)/sessions/adapter.ts` | 実装済 |
| getHistorySessions | adapter関数 | `src/app/(main)/sessions/adapter.ts` | 実装済 |
| getCalendarSessions | adapter関数 | `src/app/(main)/sessions/adapter.ts` | 実装済 |
| getAllSystems | adapter関数 | `src/app/(main)/sessions/adapter.ts` | 実装済 |

---

## 10. 関連ドキュメント

| ドキュメント | 説明 |
|--------------|------|
| `requirements-v1.md` セクション11 | 元の要件定義 |
| `requirements-session-flow.md` | セッションフロー全体の詳細要件 |
| `user-personas` メモリ | ペルソナ詳細 |
| `competitor-analysis` メモリ | 競合分析（TRPGオンセンのカレンダーUI参考） |
