# フィードバック管理システム 詳細要件定義書

**作成日**: 2026-01-21
**最終更新**: 2026-02-15（UX/技術レビュー指摘反映）

---

## 目次

- [1. 概要](#1-概要)
- [2. データモデル](#2-データモデル)
- [3. ユーザー向け機能](#3-ユーザー向け機能)
- [4. 管理者向け機能](#4-管理者向け機能)
- [5. 通知機能](#5-通知機能)
- [6. セキュリティ・荒らし対策](#6-セキュリティ荒らし対策)
- [7. URL設計](#7-url設計)
- [8. 実装優先度](#8-実装優先度)
- [9. ユーザーストーリー](#9-ユーザーストーリー)

---

## 1. 概要

### 1.1 目的

ユーザーからのバグ報告・機能要望を収集・管理し、開発改善に活かす仕組みを提供する。

### 1.2 設計原則

| 原則 | 説明 |
|------|------|
| **低フリクション** | 3クリック以内で報告完了 |
| **透明性** | 報告の進捗がユーザーに見える |
| **重複防止** | 同じ要望は投票で集約 |
| **荒らし防止** | ログイン必須、通報機能 |

### 1.3 決定事項

| 項目 | 決定 |
|------|------|
| 通知方法 | システム内通知のみ |
| 公開範囲 | ログイン済みユーザーのみ |
| 管理者権限 | 既存のMODERATORロールを使用 |
| ストレージ | Cloudflare R2（既存のアップロード基盤を再利用） |
| アイコン | `@phosphor-icons/react/ssr`（プロジェクト規約に準拠） |

---

## 2. データモデル

### 2.1 feedbacks テーブル

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| feedbackId | ULID | ○ | 主キー |
| userId | FK | ○ | 投稿者 |
| category | enum | ○ | BUG / FEATURE / UI_UX / OTHER |
| title | string | ○ | タイトル（100文字以内） |
| description | text | ○ | 詳細説明（2000文字以内） |
| pageUrl | string | - | 報告時のページURL |
| screenshotUrl | string | - | スクリーンショット（Cloudflare R2） |
| browserInfo | text | - | UA、画面サイズ等（JSON文字列として格納、自動収集） |
| status | enum | ○ | NEW / TRIAGED / PLANNED / IN_PROGRESS / DONE / WONT_FIX / DUPLICATE |
| priority | enum | - | LOW / MEDIUM / HIGH / CRITICAL |
| voteCount | integer | ○ | 投票数（デフォルト: 0）※ DBトリガーで自動更新（10.4参照） |
| mergedIntoId | FK | - | 重複時のマージ先 |
| adminNote | text | - | 管理者メモ（内部用、非公開） |
| createdAt | timestamp | ○ | 作成日時 |
| updatedAt | timestamp | ○ | 更新日時 |
| resolvedAt | timestamp | - | 解決日時 |

### 2.2 feedbackVotes テーブル

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| feedbackId | FK | ○ | フィードバックID |
| userId | FK | ○ | 投票者 |
| createdAt | timestamp | ○ | 投票日時 |

※ PRIMARY KEY (feedbackId, userId)

### 2.3 feedbackComments テーブル

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| commentId | ULID | ○ | 主キー |
| feedbackId | FK | ○ | フィードバックID |
| userId | FK | ○ | 投稿者 |
| content | text | ○ | コメント内容（1000文字以内） |
| isOfficial | boolean | ○ | 運営からの回答か（デフォルト: false） |
| createdAt | timestamp | ○ | 作成日時 |

### 2.4 notifications テーブル（システム内通知用）

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| notificationId | ULID | ○ | 主キー |
| userId | FK | ○ | 通知先ユーザー |
| type | enum | ○ | FEEDBACK_STATUS_CHANGED / FEEDBACK_COMMENT / etc. |
| title | string | ○ | 通知タイトル |
| message | text | ○ | 通知本文 |
| linkUrl | string | - | 遷移先URL |
| isRead | boolean | ○ | 既読フラグ（デフォルト: false） |
| createdAt | timestamp | ○ | 作成日時 |

**通知テーブルの肥大化対策**:
- 30日以上経過した既読通知を定期削除（pg_cron）
- 未読通知が100件を超えたら古いものから既読にする

### 2.5 Enum定義

Enum は PostgreSQL で `CREATE TYPE` として定義し、`supabase gen types typescript` で TypeScript 型を再生成する。
アプリケーション側では `src/db/enum.ts` に `{ value, label }` オブジェクトとして定義する（既存パターンに準拠）。

**カテゴリ**:

| 内部値 | 表示名 |
|--------|--------|
| BUG | バグ報告 |
| FEATURE | 機能要望 |
| UI_UX | UI/UX改善 |
| OTHER | その他 |

**ステータス**:

| 内部値 | ユーザー向け表示名 | 説明 |
|--------|-------------------|------|
| NEW | 受付中 | 新規（未トリアージ） |
| TRIAGED | 検討中 | トリアージ済み |
| PLANNED | 対応予定 | 対応が決定 |
| IN_PROGRESS | 対応中 | 実装中 |
| DONE | 完了 | 対応完了 |
| WONT_FIX | 見送り | 対応しない |
| DUPLICATE | 統合済み | 重複としてマージ済み |

**優先度**:

| 内部値 | 表示名 |
|--------|--------|
| LOW | 低 |
| MEDIUM | 中 |
| HIGH | 高 |
| CRITICAL | 緊急（本番障害等） |

**通知タイプ**:

| 内部値 | 説明 |
|--------|------|
| FEEDBACK_STATUS_CHANGED | フィードバックのステータス変更 |
| FEEDBACK_COMMENT | フィードバックへのコメント |
| FEEDBACK_MERGED | フィードバックがマージされた |

※ これらの Enum は DB 側に既に作成済み。`src/db/enum.ts` にも定義済み。

---

## 3. ユーザー向け機能

### 3.1 フィードバック投稿への導線（全ページ共通）

**配置**: 既存の SpeedDialFAB 内のメニュー項目として統合済み

**アクセス方法**:
1. 画面右下の SpeedDialFAB を開く
2. 「フィードバック」メニュー項目を選択
3. FeedbackModal が表示される

※ SpeedDial 経由で2タップで投稿フォームに到達。「3クリック以内」の原則を満たす。

**フィードバック一覧への導線**:
- SpeedDialFAB メニューに「みんなのフィードバックを見る」リンクを追加 → `/feedback` へ遷移
- FeedbackModal 内のヒントボックス「既存のフィードバックを検索する」→ `/feedback` へのリンクとして機能させる
- モバイル: BottomNav の SpeedDial からも同様にアクセス可能

### 3.2 フィードバック投稿フォーム（モーダル）

**投稿方法はモーダルのみ**。専用ページ（`/feedback/new`）は設けない。既存の FeedbackModal 実装を正とする。

```
┌─────────────────────────────────────────────────────┐
│ フィードバックを送る                          [×]   │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 種類:                                               │
│ [● バグ報告] [○ 機能要望] [○ UI改善] [○ その他]   │
│                                                     │
│ タイトル（必須）:                                   │
│ ┌─────────────────────────────────────────────────┐ │
│ │                                                 │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 詳細（必須）:                                       │
│ ┌─────────────────────────────────────────────────┐ │
│ │                                                 │ │
│ │                                                 │ │
│ │                                                 │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [Camera スクリーンショットを追加]                    │
│                                                     │
│ ───────────────────────────────────────────────────│
│ Lightbulb 同じ要望がないか確認してみましょう        │
│    [みんなのフィードバックを見る →]  (/feedback)    │
│ ───────────────────────────────────────────────────│
│                                                     │
│ [送信する]  [キャンセル]                           │
└─────────────────────────────────────────────────────┘
```

**自動収集情報**（ユーザー入力不要）:
- 現在のページURL（`pageUrl`）
- ブラウザ情報（`browserInfo`）
  - User Agent
  - 画面サイズ
  - 言語設定

**バリデーション**:
| フィールド | ルール |
|-----------|--------|
| category | 必須、enum値 |
| title | 必須、1〜100文字 |
| description | 必須、1〜2000文字 |
| screenshotUrl | 任意、画像URL形式 |

**レート制限到達時**:
- フォームを開く前に残り投稿数をチェック
- 制限到達時はフォームを開かず、メッセージを表示:「本日の投稿上限（10件）に達しました。明日再度お試しください」

### 3.3 フィードバック一覧ページ（/feedback）

**アクセス条件**: ログイン必須

```
┌─────────────────────────────────────────────────────────────┐
│ フィードバック                        [+ 新規投稿]          │
├─────────────────────────────────────────────────────────────┤
│ [すべて] [バグ] [機能要望] [UI改善] [自分の投稿]           │
├─────────────────────────────────────────────────────────────┤
│ 検索: [________________]                                    │
│ ステータス: [検討中も表示 ✓]                               │
│ ソート: [投票数順 ▼]                                       │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [▲ 42]  検索結果の保存機能が欲しい         [機能要望]  │ │
│ │         よく使う検索条件を保存して...       [対応予定]  │ │
│ │         投稿者: yamada  3日前  コメント: 5             │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [▲ 28]  カレンダー表示でセッションが重なる   [バグ]    │ │
│ │         同じ日に複数セッションがある...      [対応中]   │ │
│ │         投稿者: tanaka  1週間前  コメント: 3           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [もっと見る]                                                │
└─────────────────────────────────────────────────────────────┘
```

**Empty State（0件時の表示）**:

```
┌─────────────────────────────────────────────────────────────┐
│ フィードバック                        [+ 新規投稿]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│              まだフィードバックがありません。                │
│              最初の投稿者になりましょう！                    │
│                                                             │
│              [フィードバックを投稿する]                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

- カテゴリフィルタで0件の場合:「この種類のフィードバックはまだありません」
- 検索結果0件の場合:「検索条件に一致するフィードバックが見つかりませんでした」

**カード表示情報**:
| 項目 | 説明 |
|------|------|
| 投票数 | 左端に大きく表示、投票ボタン兼用 |
| タイトル | フィードバックタイトル |
| カテゴリバッジ | バグ報告 / 機能要望 / UI改善 / その他 |
| ステータスバッジ | 受付中 / 検討中 / 対応予定 / 対応中 / 完了 等（日本語表示） |
| 説明（冒頭） | 50文字程度でトランケート |
| 投稿者名 | ユーザー名 |
| 投稿日時 | 相対時間（3日前 等） |
| コメント数 | コメントがある場合のみ表示 |

**投票ボタンのアクセシビリティ**:
- 最小タップ領域: 44x44px（WCAG 2.5.8 AA準拠）
- 投票済み状態: primary色でハイライト、`aria-pressed="true"` を設定
- 未投票状態: デフォルト色、`aria-pressed="false"` を設定
- 投票数の変化: `aria-live="polite"` でスクリーンリーダーに通知

**フィルタ・ソート**:
| 条件 | 選択肢 |
|------|--------|
| カテゴリ | すべて / バグ / 機能要望 / UI改善 / その他 |
| タブ | すべて / 自分の投稿 |
| ステータス | デフォルトは対応予定・対応中・完了のみ。トグルで検討中も表示 |
| 検索 | タイトル・説明の部分一致 |
| ソート | 投票数順（デフォルト） / 新着順 / コメント数順 |

**表示件数**:
- 初期表示: 20件
- 「もっと見る」で20件ずつ追加（オフセットベース）
- URLにページ情報を含め、将来のカーソルベース移行に備える

### 3.4 フィードバック詳細ページ（/feedback/[id]）

```
┌─────────────────────────────────────────────────────────────┐
│ [←] フィードバック詳細                                      │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [▲ 42]  この要望に投票する                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [機能要望]  [対応予定]                                      │
│                                                             │
│ 検索結果の保存機能が欲しい                                  │
│                                                             │
│ よく使う検索条件を保存して、ワンクリックで呼び出せると      │
│ 便利だと思います。例えば「CoC7版・4人・3時間以内」のような  │
│ 条件をお気に入りとして保存したいです。                      │
│                                                             │
│ 投稿者: yamada  2026/01/15                                  │
│                                                             │
│ [スクリーンショット]（あれば表示）                          │
│                                                             │
│ ※ マージされたフィードバックの場合:                        │
│ 「このフィードバックには○件の類似投稿が統合されています」  │
├─────────────────────────────────────────────────────────────┤
│ コメント (5件)                                              │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Seal 運営                                               │ │
│ │ この機能は次回アップデートで対応予定です。              │ │
│ │ 優先度: 高  予定時期: 2026年2月                         │ │
│ │ 1/18 13:00                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ suzuki                                                  │ │
│ │ 私もこれ欲しいです！                                    │ │
│ │ 1/16 10:30                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ コメントを追加:                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│ [コメントする]                                              │
└─────────────────────────────────────────────────────────────┘
```

**投票機能**:
- 楽観的更新パターンで実装（10.2参照）
- 1ユーザー1フィードバックにつき1票
- 再クリックで投票取り消し
- 投票ボタン: 最小44x44px、`aria-pressed` で状態表現

**コメント機能**:
- 運営コメントは `Seal` アイコン + 「運営」バッジ付きで視覚的に区別
- コメントは時系列順（古い順）
- 1000文字以内

**マージされたフィードバックの表示**:
- ステータスが DUPLICATE の場合、マージ先フィードバックへのリンクを表示
- マージ先の詳細ページには「このフィードバックには○件の類似投稿が統合されています」と表示

### 3.5 投稿者向け機能

**編集**: 投稿者本人のみ、ステータスが NEW または TRIAGED の間のみ編集可能

- TRIAGED 状態で編集した場合、ステータスは自動的に NEW に戻る（再トリアージが必要）
- これにより管理者のトリアージ判断と投稿内容の整合性を保つ

**削除**: 投稿者本人のみ、ステータスがNEWの間のみ削除可能

---

## 4. 管理者向け機能

### 4.1 権限

**MODERATOR**ロールを持つユーザーが以下の操作を実行可能:

| 操作 | 説明 |
|------|------|
| ステータス変更 | 全フィードバックのステータスを変更 |
| 優先度設定 | 優先度の設定・変更 |
| 公式コメント | `isOfficial: true`のコメント投稿 |
| マージ | 重複フィードバックのマージ |
| 削除 | 不適切なフィードバックの削除 |

### 4.2 管理ダッシュボード（/admin/feedback）

**アクセス条件**: MODERATORのみ

```
┌─────────────────────────────────────────────────────────────┐
│ フィードバック管理                                          │
├─────────────────────────────────────────────────────────────┤
│ ┌───────────┬───────────┬───────────┬───────────┐           │
│ │ 新規: 12  │ 対応中: 5 │ 今週完了: 8│ 総投票: 234│          │
│ └───────────┴───────────┴───────────┴───────────┘           │
├─────────────────────────────────────────────────────────────┤
│ [要トリアージ] [対応予定] [対応中] [すべて]                │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ☐  検索結果の保存機能が欲しい              投票: 42    │ │
│ │     [機能要望] [受付中]                     yamada      │ │
│ │     [ステータス ▼] [優先度 ▼] [マージ] [削除]          │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 一括操作: [ステータス変更 ▼] [優先度変更 ▼] [実行]        │
└─────────────────────────────────────────────────────────────┘
```

**サマリーカード**:
| 項目 | 説明 |
|------|------|
| 新規 | ステータスがNEWの件数 |
| 対応中 | ステータスがIN_PROGRESSの件数 |
| 今週完了 | 今週DONEになった件数 |
| 総投票 | 全フィードバックの投票数合計 |

**タブ**:
| タブ | 表示内容 |
|------|----------|
| 要トリアージ | ステータスがNEWのもの |
| 対応予定 | ステータスがPLANNEDのもの |
| 対応中 | ステータスがIN_PROGRESSのもの |
| すべて | 全件（フィルタ可能） |

### 4.3 トリアージ操作

フィードバックカードから直接操作:

**ステータス変更**:
- ドロップダウンで即時変更
- 変更時に投稿者へ通知

**優先度設定**:
- ドロップダウンで即時変更
- LOW / MEDIUM / HIGH / CRITICAL

**マージ**:
- クリック時にモーダル表示
- マージ先のフィードバックを検索・選択
- マージ実行は Supabase RPC（PostgreSQL関数）でアトミックに処理:
  1. 元の `feedback_votes` からマージ先に未投票のユーザーのみ INSERT
  2. 元の `feedback_votes` を DELETE
  3. マージ先の `vote_count` を再計算（COUNT クエリ）
  4. 元のフィードバックのステータスを DUPLICATE に変更
  5. `mergedIntoId` にマージ先IDを設定
  6. 投稿者に通知
- ※ 同一ユーザーがマージ元・先の両方に投票済みの場合は重複を除外

**公式コメント**:
- 詳細ページから投稿
- `isOfficial: true`で保存
- 投稿者に通知（Phase 2初期は投稿者のみ。投票者通知はグルーピング実装後に追加）

### 4.4 一括操作

チェックボックスで複数選択し、一括でステータス・優先度を変更可能。

---

## 5. 通知機能

### 5.1 システム内通知

**通知センター**: ヘッダーのベルアイコン

**通知一覧**: ドロップダウンまたは専用ページ（/notifications）

### 5.2 通知トリガー

**Phase 2 初期**（投稿者のみに通知）:

| イベント | 通知対象 | 通知内容 |
|----------|----------|----------|
| ステータス変更 | 投稿者 | 「フィードバックのステータスが○○に変更されました」 |
| 公式コメント | 投稿者 | 「フィードバックに運営からコメントがつきました」 |
| 完了（DONE） | 投稿者 | 「フィードバックが対応完了しました」 |
| マージ | 元の投稿者 | 「フィードバックが類似の投稿と統合されました」 |

**Phase 2 後期**（投票者への通知を追加、グルーピング実装と同時）:

| イベント | 通知対象 | 通知内容 |
|----------|----------|----------|
| 公式コメント | 投票者（グルーピング） | 「投票した○件のフィードバックに更新がありました」 |
| 完了（DONE） | 投票者（グルーピング） | 「投票したフィードバックが対応完了しました」 |

※ 投票者への個別通知（1フィードバックにつき投票者数分のレコード）は行わない。グルーピングで集約する。

### 5.3 通知UI

```
┌─────────────────────────────────────────────────────┐
│ 通知                                    [すべて既読] │
├─────────────────────────────────────────────────────┤
│ ● フィードバックが対応完了しました        1時間前   │
│   「検索結果の保存機能」が実装されました            │
├─────────────────────────────────────────────────────┤
│ ○ 運営からコメントがつきました            3時間前   │
│   「カレンダー表示の不具合」に回答がありました      │
├─────────────────────────────────────────────────────┤
│ ○ ステータスが変更されました              1日前     │
│   「UI改善の提案」が対応予定になりました            │
└─────────────────────────────────────────────────────┘
```

- ●: 未読
- ○: 既読
- クリックで該当フィードバック詳細ページへ遷移

---

## 6. セキュリティ・荒らし対策

### 6.1 アクセス制御

| 機能 | 未ログイン | MEMBER | MODERATOR |
|------|-----------|--------|-----------|
| フィードバック一覧閲覧 | ✕ | ○ | ○ |
| フィードバック詳細閲覧 | ✕ | ○ | ○ |
| フィードバック投稿 | ✕ | ○ | ○ |
| 投票 | ✕ | ○ | ○ |
| コメント投稿 | ✕ | ○ | ○ |
| 自分の投稿を編集 | - | ○※ | ○ |
| ステータス・優先度変更 | ✕ | ✕ | ○ |
| マージ・削除 | ✕ | ✕ | ○ |
| 公式コメント | ✕ | ✕ | ○ |
| 管理ダッシュボード | ✕ | ✕ | ○ |

※ ステータスが NEW または TRIAGED の間のみ。TRIAGED で編集した場合は NEW に自動リセット。

### 6.2 レート制限

**実装方式**: DBカウント方式（Cloudflare Pages のステートレス環境で動作させるため）

- フィードバック投稿: `feedbacks` テーブルで `WHERE user_id = $1 AND created_at > NOW() - INTERVAL '1 day'` をカウント
- コメント投稿: `feedback_comments` テーブルで `WHERE user_id = $1 AND created_at > NOW() - INTERVAL '1 hour'` をカウント

| 操作 | 制限 | 制限到達時のUI |
|------|------|----------------|
| フィードバック投稿 | 1ユーザーあたり1日10件まで | 「本日の投稿上限（10件）に達しました。明日再度お試しください」 |
| コメント投稿 | 1ユーザーあたり1時間20件まで | 「コメントの投稿上限に達しました。しばらくお待ちください」 |
| 投票 | 制限なし（1フィードバック1票の制約のみ） | - |

### 6.3 コンテンツフィルタリング

- 同一内容の連続投稿を検知してブロック
- 将来的にNGワードフィルタを検討

### 6.4 通報機能（Phase 2）

- 不適切なフィードバック・コメントを通報
- MODERATORが確認して対応

---

## 7. URL設計

| パス | 説明 | アクセス |
|------|------|----------|
| `/feedback` | フィードバック一覧 | ログイン必須 |
| `/feedback/[id]` | フィードバック詳細 | ログイン必須 |
| `/admin/feedback` | 管理ダッシュボード | MODERATOR専用 |
| `/notifications` | 通知一覧 | ログイン必須 |

※ 新規投稿は FeedbackModal（モーダル）で行う。専用ページは設けない。

### 7.1 クエリパラメータ（/feedback）

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| category | カテゴリフィルタ | `category=bug` |
| status | ステータスフィルタ | `status=planned,in_progress` |
| q | 検索キーワード | `q=検索` |
| sort | ソート順 | `sort=votes`, `sort=newest` |
| mine | 自分の投稿のみ | `mine=true` |

---

## 8. 実装優先度

### Phase 1（MVP）

| 機能 | 理由 |
|------|------|
| feedbacks, feedbackVotes, feedbackComments テーブル | データ基盤 |
| フィードバック投稿フォーム（モーダル） | 収集の入口（実装済み） |
| フィードバック一覧・詳細ページ | 透明性確保 |
| 一覧ページへの導線（SpeedDial, Modal内リンク） | ページへの到達手段 |
| 投票機能 | 優先度付けの基盤 |
| voteCount の DB トリガー | 投票数の整合性保証 |
| DBカウント方式のレート制限 | 荒らし対策 |
| 基本的なステータス管理（管理者） | ワークフロー |

### Phase 2

| 機能 | 理由 |
|------|------|
| notifications テーブル | 通知基盤 |
| システム内通知 - 投稿者のみ（ベルアイコン、通知一覧） | ユーザーエンゲージメント |
| スクリーンショット添付（Cloudflare R2） | バグ報告の質向上 |
| 管理ダッシュボード（サマリー、一括操作） | 管理効率化 |
| マージ機能（Supabase RPC） | 重複管理 |
| 通報機能 | 荒らし対策強化 |
| 投票者へのグルーピング通知 | エンゲージメント向上（肥大化対策込み） |

### Phase 3（将来検討）

| 機能 | 理由 |
|------|------|
| ロードマップ公開ページ | 開発の透明性 |
| GitHub Issue連携 | 開発プロセス統合 |
| 類似フィードバックの自動提案 | 重複防止の自動化 |

---

## 9. ユーザーストーリー

```
US-F01: ユーザーとして、どのページからでもフィードバックを送れる
US-F02: ユーザーとして、バグ報告時にスクリーンショットを添付できる
US-F03: ユーザーとして、他の人のフィードバックを検索できる
US-F04: ユーザーとして、フィードバックに投票できる
US-F05: ユーザーとして、自分の投稿の進捗を確認できる
US-F06: ユーザーとして、運営の回答をコメントで確認できる
US-F07: ユーザーとして、フィードバックにコメントできる
US-F08: ユーザーとして、ステータス変更時に通知を受け取れる
US-F09: MODERATORとして、新着フィードバックをトリアージできる
US-F10: MODERATORとして、ステータス・優先度を管理できる
US-F11: MODERATORとして、公式コメントを投稿できる
US-F12: MODERATORとして、重複フィードバックをマージできる
US-F13: MODERATORとして、不適切なフィードバックを削除できる
```

---

## 10. 技術的補足

### 10.1 スクリーンショット保存

- **保存先**: Cloudflare R2（既存の `src/app/api/upload/route.ts` を再利用）
- **パス**: `feedback-screenshots/{timestamp}-{uuid}.{ext}`
- **形式**: PNG / JPEG / WebP
- **最大サイズ**: 5MB
- **アクセス制御**: 認証済みユーザーのみアップロード可、閲覧はログイン済みユーザー

### 10.2 投票の実装

```typescript
// 楽観的更新パターン（CLAUDE.md準拠）
// useOptimistic は1オブジェクトにまとめてロールバック時の整合性を確保
const [optimistic, setOptimistic] = useOptimistic(
  { hasVoted, voteCount },
  (state, newHasVoted: boolean) => ({
    hasVoted: newHasVoted,
    voteCount: newHasVoted ? state.voteCount + 1 : state.voteCount - 1,
  })
)

const handleVote = () => {
  setOptimistic(!optimistic.hasVoted)
  startTransition(async () => {
    await toggleFeedbackVote(feedbackId)
  })
}
```

**アクセシビリティ**:
- 投票ボタン: `<button aria-pressed={optimistic.hasVoted} aria-label="投票">`
- 投票数表示: `<span aria-live="polite">{optimistic.voteCount}票</span>`

### 10.3 browserInfo の収集

```typescript
const collectBrowserInfo = () => ({
  userAgent: navigator.userAgent,
  screenWidth: window.screen.width,
  screenHeight: window.screen.height,
  viewportWidth: window.innerWidth,
  viewportHeight: window.innerHeight,
  language: navigator.language,
  platform: navigator.platform,
})
// JSON.stringify() して text カラムに保存
```

### 10.4 voteCount の整合性保証（DBトリガー）

`feedback_votes` テーブルの INSERT/DELETE をトリガーに `feedbacks.vote_count` を自動更新する。

```sql
-- PostgreSQL トリガー関数
CREATE OR REPLACE FUNCTION update_feedback_vote_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE feedbacks SET vote_count = vote_count + 1 WHERE feedback_id = NEW.feedback_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE feedbacks SET vote_count = vote_count - 1 WHERE feedback_id = OLD.feedback_id;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- トリガー設定
CREATE TRIGGER feedback_votes_count_trigger
AFTER INSERT OR DELETE ON feedback_votes
FOR EACH ROW EXECUTE FUNCTION update_feedback_vote_count();
```

これによりアプリケーション層での `vote_count` 更新は不要。同時投票時のレースコンディションも防止される。

---

**以上**
