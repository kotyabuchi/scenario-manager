# 認証画面（Login / Signup 統合）要件定義書

**作成日**: 2026-01-28
**TDDフェーズ**: 要件定義

---

## 1. 概要

### 1.1 目的

Discord OAuthによる認証と初回ユーザー登録を、シームレスなフローで提供する。
独立したログイン/サインアップ画面を廃止し、アプリ内の各所からDiscord認証を直接呼び出す形に統合する。

### 1.2 対象ユーザー

- 田中さん（週末GM・30代）: サクッとログインしてセッション管理したい
- 鈴木さん（新人PL・20代）: 初めてのサービスに手軽に登録したい
- すべてのユーザー: Discord認証のみ

### 1.3 ユーザーストーリー

```
US-A01: 未ログインユーザーとして、ランディングページからDiscord認証でログインできる
US-A02: 未ログインユーザーとして、ヘッダーのログインボタンからDiscord認証でログインできる
US-A03: 未ログインユーザーとして、認証が必要な操作をした際にDiscord認証に導かれる
US-A04: 初回ログインユーザーとして、認証後にプロフィール設定ができる（ステップ形式）
US-A05: 初回ログインユーザーとして、Step2（任意項目）をスキップして登録完了できる
US-A06: 認証済みユーザーとして、ログイン前に見ていたページに自動的に戻れる
US-A07: 認証済みユーザーとして、ランディングページから直接シナリオ一覧に遷移する
```

---

## 2. 機能要件

### 2.1 認証フロー全体

```
[未ログイン]
  ├── ランディングページ（/）
  │     └── CTAボタン → ログイン状態チェック
  │           ├── ログイン済み → /scenarios へ遷移
  │           └── 未ログイン → Discord OAuth を直接起動
  │
  ├── ヘッダーのログインボタン
  │     └── クリック → Discord OAuth を直接起動
  │
  └── 認証が必要な操作（セッション参加等）
        └── クリック → Discord OAuth を直接起動

[Discord OAuth 完了]
  └── /auth/callback
        ├── 既存ユーザー → リダイレクト元のページに戻る（なければ /home）
        └── 新規ユーザー → /signup（プロフィール設定画面）へ遷移
```

### 2.2 ランディングページの認証ボタン動作

| 状態 | ボタン表示 | 動作 |
|------|-----------|------|
| 未ログイン | 「はじめる」等のCTA | Discord OAuth を起動 |
| ログイン済み | 「シナリオを探す」等 | `/scenarios` へ遷移 |

### 2.3 ヘッダーのログインボタン動作

| 状態 | 表示 | 動作 |
|------|------|------|
| 未ログイン | 「ログイン」ボタン | Discord OAuth を起動 |
| ログイン済み | アバター / ユーザーメニュー | プロフィール等へ遷移 |

### 2.4 リダイレクト制御

- Discord OAuth 起動前に、現在のURLを `redirectTo` パラメータとして保持する
- callback後に `redirectTo` があれば元のページに戻る
- `redirectTo` がなければ `/home` へ遷移
- 新規ユーザーの場合は先に `/signup` へ遷移し、プロフィール設定完了後に元のページへ

### 2.5 プロフィール設定画面（/signup）

#### 画面構成: ステップ形式（スワイプ / スライドアニメーション）

**Step 1: 基本情報（必須）**

| 項目 | 型 | 必須 | バリデーション | 説明 |
|------|-----|------|---------------|------|
| アバター | image | - | 自動取得 | Discord アバターを表示（編集不可） |
| ユーザー名 | string | ○ | 英数字 + `_`、3〜20文字、一意 | URLやID表示用 |
| 表示名 | string | ○ | 1〜50文字 | 他ユーザーに見える名前 |

- **ユーザー名のデフォルト値**: Discord名から自動生成（特殊文字を`_`に置換、長さ調整）
- **表示名のデフォルト値**: Discordの表示名をそのまま使用
- **ユーザー名の一意性チェック**: フォーカスアウト時にリアルタイム確認
  - 使用可能 → 緑チェックマーク表示
  - 使用済み → エラーメッセージ「このユーザー名は既に使用されています」
  - チェック中 → ローディングインジケーター表示
- **「次へ」ボタン**: Step 2へスライド遷移

**Step 2: 追加情報（任意・スキップ可能）**

| 項目 | 型 | 必須 | バリデーション | 説明 |
|------|-----|------|---------------|------|
| 自己紹介 | text | - | 500文字以内 | フリーテキスト |
| 好きなシステム | string[] | - | チップ選択（複数可） | scenario_systems テーブルから取得 |
| 好きなシナリオ | string | - | 500文字以内 | フリーテキスト |

- **「スキップ」ボタン**: Step 2をスキップして登録完了
- **「登録する」ボタン**: 入力内容を保存して登録完了
- 登録完了後 → リダイレクト元のページへ遷移（なければ `/home`）

#### ステップ遷移のUI

- 横スライドアニメーション（右方向）
- Step インジケーター（ドットやステップバー）で現在位置を表示
- Step 2 → Step 1 に戻れる（左スワイプ or 戻るボタン）

### 2.6 /login ページの廃止

独立した `/login` ページは廃止する。

- `/login` へのアクセス → Discord OAuth を直接起動（互換性のため）
- または `/` へリダイレクト
- ヘッダーやランディングから直接OAuth起動するため、専用画面は不要

---

## 3. データ項目

### 3.1 ユーザー登録時に保存する項目

| カラム | 型 | 必須 | ソース | 説明 |
|--------|-----|------|--------|------|
| user_id | ULID | ○ | 自動生成 | 主キー |
| discord_id | string | ○ | Discord OAuth | Discord ユーザーID |
| user_name | string | ○ | Step 1 フォーム | ユーザー名（一意） |
| nickname | string | ○ | Step 1 フォーム | 表示名 |
| image | string | - | Discord OAuth | アバターURL |
| bio | string | - | Step 2 フォーム | 自己紹介 |
| role | enum | ○ | デフォルト: MEMBER | 権限 |
| created_at | timestamp | ○ | 自動 | 登録日時 |
| updated_at | timestamp | ○ | 自動 | 更新日時 |

### 3.2 好きなシステム

`user_favorite_systems` テーブル（未作成の場合は新規作成が必要）

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| user_id | FK | ○ | users.user_id |
| scenario_system_id | FK | ○ | scenario_systems.scenario_system_id |

### 3.3 好きなシナリオ

`users` テーブルの `favorite_scenarios` カラム（text型）として保存、
もしくは別テーブル。テキスト入力なので `users.favorite_scenarios` に格納が簡潔。

---

## 4. バリデーションルール

### 4.1 ユーザー名（userName）

| ルール | 条件 | エラーメッセージ |
|--------|------|----------------|
| 必須 | 空文字不可 | ユーザー名を入力してください |
| 文字種 | `/^[a-zA-Z0-9_]+$/` | ユーザー名は英数字とアンダースコアのみ使用できます |
| 最小文字数 | 3文字以上 | ユーザー名は3文字以上で入力してください |
| 最大文字数 | 20文字以下 | ユーザー名は20文字以内で入力してください |
| 一意性 | DB内で一意 | このユーザー名は既に使用されています |

### 4.2 表示名（nickname）

| ルール | 条件 | エラーメッセージ |
|--------|------|----------------|
| 必須 | 空文字不可 | 表示名を入力してください |
| 最大文字数 | 50文字以下 | 表示名は50文字以内で入力してください |

### 4.3 自己紹介（bio）

| ルール | 条件 | エラーメッセージ |
|--------|------|----------------|
| 最大文字数 | 500文字以下 | 自己紹介は500文字以内で入力してください |

### 4.4 好きなシナリオ（favoriteScenarios）

| ルール | 条件 | エラーメッセージ |
|--------|------|----------------|
| 最大文字数 | 500文字以下 | 500文字以内で入力してください |

---

## 5. 権限制御

| 操作 | 未ログイン | ログイン済み |
|------|-----------|-------------|
| ランディングページ閲覧 | ○ | ○ |
| Discord認証の起動 | ○ | - |
| /signup（プロフィール設定） | - | ○（初回のみ） |
| /signup へのアクセス（登録済み） | - | → /home にリダイレクト |

---

## 6. エラーケース

| ケース | 挙動 |
|--------|------|
| Discord認証キャンセル | ランディングまたは元のページに戻る。エラーメッセージは表示しない |
| Discord認証エラー | エラーメッセージ表示「ログインに失敗しました。もう一度お試しください。」 |
| ユーザー名重複（フォーカスアウト時） | 入力欄下にエラー表示 |
| ユーザー名重複（送信時） | エラーメッセージ「このユーザー名は既に使用されています」 |
| ネットワークエラー（一意性チェック） | チェックをスキップし、送信時にサーバー側で検証 |
| ネットワークエラー（送信時） | エラーメッセージ「登録に失敗しました。もう一度お試しください。」 |

---

## 7. テスト観点（/gen-test への引き継ぎ）

### 7.1 正常系

- [ ] Discord OAuth を起動してコールバックを受信できる
- [ ] 既存ユーザーがログインした場合、元のページにリダイレクトされる
- [ ] 新規ユーザーがログインした場合、/signup に遷移する
- [ ] Step 1 で有効なユーザー名・表示名を入力して次へ進める
- [ ] Step 2 をスキップして登録完了できる
- [ ] Step 2 で任意項目を入力して登録完了できる
- [ ] 登録完了後にリダイレクト元のページに遷移する
- [ ] Discord名からユーザー名・表示名がデフォルト入力される

### 7.2 異常系・境界値

- [ ] ユーザー名が空の場合、エラーメッセージが表示される
- [ ] ユーザー名が2文字の場合、エラーメッセージが表示される
- [ ] ユーザー名が3文字の場合、有効（境界値）
- [ ] ユーザー名が20文字の場合、有効（境界値）
- [ ] ユーザー名が21文字の場合、エラーメッセージが表示される
- [ ] ユーザー名に特殊文字を含む場合、エラーメッセージが表示される
- [ ] ユーザー名が重複している場合、フォーカスアウト時にエラー表示
- [ ] 表示名が空の場合、エラーメッセージが表示される
- [ ] 表示名が50文字の場合、有効（境界値）
- [ ] 表示名が51文字の場合、エラーメッセージが表示される
- [ ] 自己紹介が500文字の場合、有効（境界値）
- [ ] 自己紹介が501文字の場合、エラーメッセージが表示される
- [ ] Discord認証がキャンセルされた場合、元のページに戻る
- [ ] Discord認証がエラーの場合、エラーメッセージが表示される

### 7.3 権限制御

- [ ] 未ログインユーザーが /signup にアクセスした場合、/login（→OAuth）にリダイレクト
- [ ] 登録済みユーザーが /signup にアクセスした場合、/home にリダイレクト

---

## 8. 実装の優先度

### 8.1 MVP（必須）

- ランディングページからのDiscord認証起動
- ヘッダーのログインボタンからの認証起動
- リダイレクト制御（元のページに戻る）
- Step 1: 基本情報入力（ユーザー名 + 表示名）
- ユーザー名の一意性チェック（フォーカスアウト時）
- Discord名からのデフォルト値生成

### 8.2 Nice to Have（後回し可）

- Step 2: 追加情報入力（自己紹介、好きなシステム、好きなシナリオ）
- ステップ間のスワイプアニメーション
- `user_favorite_systems` テーブルの新規作成
- `users.favorite_scenarios` カラムの追加

---

## 9. 未決定事項

| 項目 | 検討内容 |
|------|----------|
| /login パスの扱い | 廃止してOAuthリダイレクト or ランディングにリダイレクト |
| 好きなシナリオの保存形式 | users テーブルにカラム追加 or 別テーブル |
| user_favorite_systems テーブル | 新規マイグレーション必要。既存の user_scenario_preferences との関係整理 |
| Discord名からのユーザー名生成ロジック | 特殊文字の置換ルール、重複時のサフィックス付与 |

---

## 10. TDD対象一覧

| 対象 | 種別 | ファイルパス | 備考 |
|------|------|-------------|------|
| signupFormSchema (Step1) | Zodスキーマ | `src/app/(auth)/signup/_components/schema.ts` | ユーザー名 + 表示名 |
| signupStep2Schema | Zodスキーマ | `src/app/(auth)/signup/_components/schema.ts` | 自己紹介 + 好きなシステム + 好きなシナリオ |
| checkUserNameAvailability | adapter関数 | `src/app/(auth)/signup/adapter.ts` | ユーザー名一意性チェック |
| createUser | Server Action | `src/app/(auth)/signup/actions.ts` | ユーザー登録処理 |
| generateUserName | ユーティリティ | `src/app/(auth)/signup/utils.ts` | Discord名からユーザー名自動生成 |
| AuthRedirect | ユーティリティ | `src/lib/auth/redirect.ts` | リダイレクト制御 |

---

## 11. 既存実装からの変更点

| 項目 | 現状 | 変更後 |
|------|------|--------|
| ログイン画面 | `/login` に独立した画面 | 廃止。各所からOAuth直接起動 |
| 認証ボタン | ログイン画面内のみ | ランディングCTA + ヘッダー + 認証必要操作 |
| リダイレクト先 | `/auth/callback` → `/home` 固定 | 元のページに戻る |
| プロフィール設定 | 1画面にユーザー名 + 表示名 | 2ステップ構成（Step2はスキップ可） |
| バリデーション | useState + 手動バリデーション | Zod + React Hook Form |
| ユーザー名チェック | なし | フォーカスアウト時にリアルタイムチェック |
