# シナリオ登録画面 要件定義書

**作成日**: 2026-01-27
**TDDフェーズ**: 要件定義
**パス**: `/scenarios/new`

---

## 1. 概要

### 1.1 目的
ユーザーが遊んだシナリオをデータベースに登録し、セッション作成やシナリオ検索で活用できるようにする。

### 1.2 対象ユーザー
全ログインユーザー（MEMBER以上）が利用可能。

- **田中さん（週末GM・30代）**: 所持シナリオを登録して管理したい
- **鈴木さん（新人PL・20代）**: 遊んだシナリオを記録しておきたい
- **佐藤さん（配信者・20代）**: 配信予定のシナリオを事前登録したい
- **山田さん（ベテランKP・40代）**: 多数の所持シナリオを一元管理したい

### 1.3 ユーザーストーリー
「MEMBERとして、新規シナリオを登録したい。なぜならセッションを作成するときに使いたいから。」

---

## 2. 機能要件

### 2.1 アクセス制御

| 条件 | 動作 |
|------|------|
| 未ログイン | ログインページへリダイレクト |
| MEMBER以上 | フォーム表示 |

### 2.2 画面・操作フロー

```
[シナリオ検索] → [「シナリオを登録」ボタン] → [登録フォーム] → [送信] → [シナリオ詳細ページ]
                                                    ↓
                                              [エラー表示]
                                                    ↓
                                              [修正して再送信]
```

1. ユーザーがヘッダーまたはシナリオ一覧から「シナリオを登録」を選択
2. 登録フォームが表示される
3. 必須項目を入力し、任意項目を設定
4. 「登録する」ボタンをクリック
5. バリデーション成功時 → シナリオ詳細ページへ遷移
6. バリデーション失敗時 → エラーメッセージを表示

### 2.3 データ項目

#### 必須項目

| 項目 | フィールド名 | 型 | バリデーション | 説明 |
|------|-------------|-----|---------------|------|
| シナリオ名 | name | string | 1-100文字 | シナリオのタイトル |
| システム | scenarioSystemId | string | 存在するシステムID | 対象TRPGシステム |
| ハンドアウト形式 | handoutType | enum | NONE/PUBLIC/SECRET | デフォルト: NONE |

#### 任意項目

| 項目 | フィールド名 | 型 | バリデーション | 説明 |
|------|-------------|-----|---------------|------|
| 作者名 | author | string | 最大100文字 | シナリオ製作者 |
| 概要 | description | string | 最大2000文字 | シナリオの説明文 |
| サムネイル画像 | scenarioImage | File | 5MB以下、画像形式 | 自動リサイズ |
| 配布URL | distributeUrl | string | 有効なURL形式 | Booth等の配布ページ |
| 最小プレイ人数 | minPlayer | number | 1-20 | GM除く |
| 最大プレイ人数 | maxPlayer | number | 1-20 | GM除く |
| 最小プレイ時間 | minPlaytime | number | 30-480（分） | |
| 最大プレイ時間 | maxPlaytime | number | 30-480（分） | |
| タグ | tagIds | string[] | 存在するタグID | 複数選択可 |

### 2.4 バリデーションルール

#### フィールド単体

| フィールド | ルール | エラーメッセージ |
|-----------|--------|----------------|
| name | 空文字不可 | 「シナリオ名は必須です」 |
| name | 100文字以下 | 「シナリオ名は100文字以内で入力してください」 |
| author | 100文字以下 | 「作者名は100文字以内で入力してください」 |
| description | 2000文字以下 | 「概要は2000文字以内で入力してください」 |
| minPlayer | 1-20の整数 | 「プレイ人数は1〜20人で設定してください」 |
| maxPlayer | 1-20の整数 | 「プレイ人数は1〜20人で設定してください」 |
| minPlaytime | 30-480の整数 | 「プレイ時間は30分〜8時間で設定してください」 |
| maxPlaytime | 30-480の整数 | 「プレイ時間は30分〜8時間で設定してください」 |
| distributeUrl | URL形式 | 「有効なURLを入力してください」 |
| scenarioImage | 5MB以下 | 「ファイルサイズは5MB以下にしてください」 |

#### クロスフィールドバリデーション

| ルール | エラーメッセージ |
|--------|----------------|
| minPlayer <= maxPlayer | 「最小人数は最大人数以下にしてください」 |
| minPlaytime <= maxPlaytime | 「最小時間は最大時間以下にしてください」 |

#### 重複チェック（NEW）

| ルール | エラーメッセージ |
|--------|----------------|
| 同一システム内でシナリオ名が一意 | 「同じシステムに同名のシナリオが既に登録されています」 |
| 配布URLが一意 | 「この配布URLのシナリオは既に登録されています」 |

### 2.5 画像アップロード仕様

| 項目 | 値 |
|------|-----|
| 最大ファイルサイズ | 5MB |
| 対応形式 | JPEG, PNG, WebP, GIF |
| 出力形式 | JPEG |
| 出力サイズ | 600x600px（センタークロップ） |
| JPEG品質 | 80% |

**処理フロー**:
1. ユーザーが画像を選択
2. クライアント側で自動リサイズ・圧縮
3. Supabase Storageにアップロード
4. 生成されたURLをフォームに設定

### 2.6 ビジネスルール

#### 権限

| 操作 | 登録者本人 | 他ユーザー | MODERATOR |
|------|:----------:|:----------:|:---------:|
| 登録 | ○ | - | - |
| 編集 | ○ | ✕ | ○ |
| 削除 | ✕ | ✕ | ○ |

#### スパム対策（NEW）

| ルール | 詳細 |
|--------|------|
| レートリミット | 一定時間内の登録数に制限あり |
| MODERATORは制限なし | MODERATORロールはレートリミット対象外 |
| 残り回数非表示 | ユーザーに具体的な数値は表示しない |
| 制限到達時の表示 | 「しばらく時間をおいてから再度お試しください」 |

---

## 3. UI仕様

### 3.1 フォームレイアウト

```
┌─────────────────────────────────────────┐
│ シナリオを登録                           │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 画像アップロード               │   │
│  │ （ドラッグ＆ドロップ対応）      │   │
│  └─────────────────────────────────┘   │
│                                         │
│  シナリオ名 *                           │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  システム *                             │
│  ┌─────────────────────────────────┐   │
│  │ ▼ システムを選択               │   │
│  └─────────────────────────────────┘   │
│                                         │
│  作者名                                 │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  概要                                   │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ハンドアウト形式                       │
│  ◉ なし ○ 公開 ○ 秘匿                  │
│                                         │
│  プレイ人数（GM除く）                   │
│  ┌────┐ 〜 ┌────┐ 人                   │
│  │    │    │    │                      │
│  └────┘    └────┘                      │
│  ──●────────────○── スライダー          │
│                                         │
│  プレイ時間                             │
│  ┌────┐ 〜 ┌────┐ 分                   │
│  │    │    │    │                      │
│  └────┘    └────┘                      │
│  ──●────────────○── スライダー          │
│                                         │
│  配布URL                                │
│  ┌─────────────────────────────────┐   │
│  │ https://                        │   │
│  └─────────────────────────────────┘   │
│                                         │
│  タグ                                   │
│  [ホラー] [推理] [+ タグを追加]         │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         登録する                │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 3.2 UI要素

| 要素 | コンポーネント | 備考 |
|------|--------------|------|
| 画像アップロード | FileUpload | ドラッグ＆ドロップ対応 |
| シナリオ名 | Input | テキスト入力 |
| システム | Select | 全システムから選択 |
| 作者名 | Input | テキスト入力 |
| 概要 | Textarea | 複数行入力 |
| ハンドアウト形式 | Radio | 3択 |
| プレイ人数 | RangeSlider + NumberInput | 範囲選択 |
| プレイ時間 | RangeSlider + NumberInput | 範囲選択 |
| 配布URL | Input | URL形式 |
| タグ | ChipGroup | 複数選択可 |
| 送信ボタン | Button | ローディング状態対応 |

### 3.3 インタラクション

| 状態 | 動作 |
|------|------|
| フォーム入力中 | リアルタイムバリデーション（blur時） |
| 送信ボタンクリック | 全フィールドバリデーション → 成功時はローディング表示 |
| 送信成功 | シナリオ詳細ページへ遷移 |
| 送信失敗 | エラートースト表示、フォームはそのまま |
| レートリミット超過 | エラーメッセージ表示（具体的な数値は非表示） |

---

## 4. テスト観点（/gen-test への引き継ぎ）

### 4.1 正常系

- [ ] SN-01: 必須項目のみで登録できる
- [ ] SN-02: 全項目を入力して登録できる
- [ ] SN-03: 登録成功後、シナリオ詳細ページへ遷移する
- [ ] SN-04: 画像をアップロードして登録できる
- [ ] SN-05: 複数のタグを選択して登録できる
- [ ] SN-06: プレイ人数の範囲を指定して登録できる
- [ ] SN-07: プレイ時間の範囲を指定して登録できる

### 4.2 異常系・境界値

#### バリデーション

- [ ] SN-10: シナリオ名が空の場合、エラーメッセージが表示される
- [ ] SN-11: シナリオ名が101文字の場合、エラーメッセージが表示される
- [ ] SN-12: シナリオ名が100文字の場合、登録できる
- [ ] SN-13: システム未選択の場合、エラーメッセージが表示される
- [ ] SN-14: 作者名が101文字の場合、エラーメッセージが表示される
- [ ] SN-15: 概要が2001文字の場合、エラーメッセージが表示される
- [ ] SN-16: 概要が2000文字の場合、登録できる
- [ ] SN-17: 不正なURL形式の場合、エラーメッセージが表示される
- [ ] SN-18: minPlayer > maxPlayer の場合、エラーメッセージが表示される
- [ ] SN-19: minPlaytime > maxPlaytime の場合、エラーメッセージが表示される
- [ ] SN-20: プレイ人数が0の場合、エラーメッセージが表示される
- [ ] SN-21: プレイ人数が21の場合、エラーメッセージが表示される
- [ ] SN-22: プレイ時間が29分の場合、エラーメッセージが表示される
- [ ] SN-23: プレイ時間が481分の場合、エラーメッセージが表示される

#### 重複チェック

- [ ] SN-30: 同一システムで同名シナリオが存在する場合、エラーメッセージが表示される
- [ ] SN-31: 異なるシステムで同名シナリオは登録できる
- [ ] SN-32: 既存の配布URLと重複する場合、エラーメッセージが表示される

#### 画像アップロード

- [ ] SN-40: 5MB超の画像はエラーメッセージが表示される
- [ ] SN-41: 5MBちょうどの画像はアップロードできる
- [ ] SN-42: 非画像ファイルはエラーメッセージが表示される
- [ ] SN-43: 画像はリサイズされて600x600pxになる

### 4.3 権限制御

- [ ] SN-50: 未ログイン状態でアクセスするとログインページへリダイレクト
- [ ] SN-51: MEMBER権限でフォームが表示される
- [ ] SN-52: MODERATOR権限でフォームが表示される

### 4.4 レートリミット

- [ ] SN-60: レートリミット超過時にエラーメッセージが表示される
- [ ] SN-61: MODERATORはレートリミットの対象外

### 4.5 アクセシビリティ

- [ ] SN-70: 全フォーム要素にlabelが関連付けられている
- [ ] SN-71: エラーメッセージがaria-describedbyで関連付けられている
- [ ] SN-72: Tabキーでフォーム要素を順番に移動できる
- [ ] SN-73: Enterキーでフォームを送信できる
- [ ] SN-74: 必須項目にaria-requiredが設定されている

---

## 5. 実装の優先度

### 5.1 MVP（必須）

- [x] 基本フォーム（必須項目のみ）
- [x] バリデーション（単体フィールド）
- [x] 画像アップロード
- [x] タグ選択
- [x] プレイ人数/時間の範囲入力
- [x] シナリオ詳細ページへの遷移

### 5.2 追加実装（本要件で新規）

- [ ] 重複チェック（シナリオ名+システム）
- [ ] 重複チェック（配布URL）
- [ ] レートリミット

### 5.3 Nice to Have（将来）

- [ ] 下書き保存機能
- [ ] CSV一括インポート
- [ ] シナリオ編集時の変更履歴

---

## 6. 未決定事項

| 項目 | 備考 |
|------|------|
| レートリミットの具体的な数値 | 例: 1時間に5件まで |
| レートリミットのリセットタイミング | 例: 1時間後 |

---

## 7. TDD対象一覧

| 対象 | 種別 | ファイルパス | 備考 |
|------|------|-------------|------|
| scenarioFormSchema | Zodスキーマ | `src/app/(main)/scenarios/new/_components/schema.ts` | 既存 |
| createScenario | adapter関数 | `src/app/(main)/scenarios/adapter.ts` | 既存 |
| createScenarioAction | Server Action | `src/app/(main)/scenarios/new/actions.ts` | 既存 |
| checkScenarioNameDuplicate | adapter関数 | `src/app/(main)/scenarios/adapter.ts` | **新規** |
| checkDistributeUrlDuplicate | adapter関数 | `src/app/(main)/scenarios/adapter.ts` | **新規** |
| checkRateLimit | util関数 | `src/lib/rateLimit.ts` | **新規** |
| ScenarioForm | コンポーネント | `src/app/(main)/scenarios/new/_components/ScenarioForm.tsx` | 既存 |

---

## 8. 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `.claude/requirements/requirements-v1.md` §4 | シナリオ管理の基本仕様 |
| `src/db/enum.ts` | HandoutType Enum定義 |
| `src/lib/image.ts` | 画像リサイズ設定 |
