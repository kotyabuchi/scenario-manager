# プロフィール機能 要件定義書

**作成日**: 2026-01-22
**TDDフェーズ**: 要件定義

---

## 1. 概要

### 1.1 目的
ユーザーが自分のプロフィール情報を管理し、他のユーザーに自己紹介できる機能を提供する。

### 1.2 対象ユーザー
- 全ログインユーザー（MEMBER / MODERATOR）

### 1.3 ユーザーストーリー
- 「ユーザーとして、自分の表示名と自己紹介を編集したい。なぜならセッションで他の参加者に自分を知ってもらいたいから。」
- 「ユーザーとして、ユーザーIDを変更したい。なぜなら初期設定のIDが気に入らないから。」
- 「MODERATORとして、不適切なプロフィールを編集したい。なぜなら荒らし対策が必要だから。」

---

## 2. 機能要件

### 2.1 プロフィール閲覧（getUserById）

#### 機能概要
ユーザーIDを指定してプロフィール情報を取得する。

#### 入出力

| 項目 | 型 | 説明 |
|------|-----|------|
| 入力: userId | string (ULID) | ユーザーID（26文字） |
| 出力: user | User \| null | ユーザー情報またはnull |

#### ビジネスルール
- 存在しないユーザーIDの場合はnullを返す
- エラー発生時はResult.errを返す

---

### 2.2 プロフィール編集（updateUserProfile）

#### 機能概要
ユーザーのプロフィール情報を更新する。

#### 入出力

| 項目 | 型 | 説明 |
|------|-----|------|
| 入力: userId | string (ULID) | 対象ユーザーID |
| 入力: nickname | string | 表示名 |
| 入力: bio | string \| undefined | 自己紹介 |
| 入力: userName | string | ユーザーID（変更可能） |
| 出力: user | User | 更新後のユーザー情報 |

#### 権限制御

| 操作者 | 対象 | 許可 |
|--------|------|------|
| 本人 | 自分のプロフィール | ○ |
| MODERATOR | 任意のユーザー | ○ |
| MEMBER | 他人のプロフィール | ✕ |

#### ビジネスルール
- 存在しないユーザーIDの場合はエラーを返す
- userNameの重複チェックを行い、既存の場合はエラーを返す
- updatedAtを更新日時に設定する

---

### 2.3 プロフィールフォームスキーマ（profileFormSchema）

#### データ項目

| 項目 | 型 | 必須 | バリデーション | エラーメッセージ |
|------|-----|------|---------------|-----------------|
| userName | string | ○ | 3-30文字、英数字とアンダースコアのみ | 「ユーザーIDは3〜30文字の英数字で入力してください」 |
| nickname | string | ○ | 1-50文字 | 「表示名を入力してください」「表示名は50文字以内で入力してください」 |
| bio | string | - | 0-500文字 | 「自己紹介は500文字以内で入力してください」 |

#### userName フォーマット
- 使用可能文字: 半角英字（a-z, A-Z）、数字（0-9）、アンダースコア（_）
- 正規表現: `/^[a-zA-Z0-9_]+$/`
- 大文字小文字を区別する

---

## 3. 非機能要件

### 3.1 プロフィール画像
- Discord OAuthから取得した画像をそのまま使用
- カスタム画像のアップロードは対応しない（将来検討）

### 3.2 パフォーマンス
- プロフィール取得: 500ms以内

---

## 4. テスト観点（/gen-test への引き継ぎ）

### 4.1 profileFormSchema

#### 正常系
- [ ] T-PF-001: 有効なuserName（英数字のみ）でバリデーション成功
- [ ] T-PF-002: 有効なuserName（アンダースコア含む）でバリデーション成功
- [ ] T-PF-003: 有効なnickname（1文字）でバリデーション成功
- [ ] T-PF-004: 有効なnickname（50文字）でバリデーション成功
- [ ] T-PF-005: bioが空でもバリデーション成功
- [ ] T-PF-006: 有効なbio（500文字）でバリデーション成功

#### 異常系
- [ ] T-PF-101: userNameが空でエラー
- [ ] T-PF-102: userNameが2文字でエラー（最小3文字）
- [ ] T-PF-103: userNameが31文字でエラー（最大30文字）
- [ ] T-PF-104: userNameに日本語が含まれるとエラー
- [ ] T-PF-105: userNameにハイフンが含まれるとエラー
- [ ] T-PF-106: userNameにスペースが含まれるとエラー
- [ ] T-PF-107: nicknameが空でエラー
- [ ] T-PF-108: nicknameが51文字でエラー
- [ ] T-PF-109: bioが501文字でエラー

### 4.2 getUserById

#### 正常系
- [ ] T-GU-001: 存在するユーザーIDで情報を取得できる
- [ ] T-GU-002: 存在しないユーザーIDでnullを返す

#### 異常系
- [ ] T-GU-101: DB接続エラー時にResult.errを返す

### 4.3 updateUserProfile

#### 正常系
- [ ] T-UP-001: nickname更新が成功する
- [ ] T-UP-002: bio更新が成功する
- [ ] T-UP-003: userName更新が成功する
- [ ] T-UP-004: 全項目同時更新が成功する
- [ ] T-UP-005: bioをnullに更新できる

#### 異常系
- [ ] T-UP-101: 存在しないユーザーIDでエラー
- [ ] T-UP-102: userNameが重複している場合エラー
- [ ] T-UP-103: DB接続エラー時にResult.errを返す

---

## 5. TDD対象一覧

| 対象 | 種別 | ファイルパス | 備考 |
|------|------|-------------|------|
| profileFormSchema | Zodスキーマ | `src/components/blocks/Profile/schema.ts` | userName追加が必要 |
| getUserById | adapter関数 | `src/app/(main)/users/[id]/adapter.ts` | |
| updateUserProfile | adapter関数 | `src/app/(main)/profile/adapter.ts` | userName更新追加が必要 |

---

## 6. 実装の優先度

### 6.1 MVP（必須）
- profileFormSchemaにuserName追加
- updateUserProfileでuserName更新対応
- 全テストケースの実装

### 6.2 Nice to Have（後回し可）
- プロフィール画像のカスタムアップロード
- userName変更履歴の保持

---

## 7. 未決定事項

なし

