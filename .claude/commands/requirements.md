---
allowed-tools: Read, Glob, Grep, Write, Edit, AskUserQuestion, mcp__serena__list_memories, mcp__serena__read_memory, mcp__serena__write_memory, mcp__serena__edit_memory
description: 要件定義を対話的に作成・改善する。新機能の仕様策定や既存要件のブラッシュアップに使用。
---

# /requirements コマンド

## 概要

**TDD開発フローの最初のフェーズ**

ユーザーと対話しながら要件を明確化し、構造化されたドキュメントを作成するスキル。
要件定義が完了したら、PROGRESS.mdを更新し、次フェーズ（`/gen-test`）へ引き継ぐ。

```
[/requirements] → /gen-test → /implement-tests → /refactor
    ↓
 要件定義書作成
    ↓
 PROGRESS.md更新（要件定義: ✅）
```

## 使用方法

```bash
/requirements                         # 新規要件定義を開始
/requirements refine <機能名>          # 既存要件を見直す
/requirements refine <機能名> --focus <領域>  # 特定領域を重点的に補完
/requirements <機能のアイデア>          # アイデアから要件を作成
```

### --focus オプション

`/gen-test` から呼び出される際に使用。特定の領域を重点的にヒアリング:

| 領域 | 補完内容 |
|------|----------|
| `バリデーションルール` | 文字数制限、必須項目、Enum値、形式チェック |
| `権限制御` | 誰が何をできるか、ロール別の操作権限 |
| `エラーケース` | 異常系の挙動、エラーメッセージ |
| `画面フロー` | 操作手順、状態遷移、モーダル/ページ遷移 |
| `境界値` | 数値・文字数の上限下限、0件/大量データ時の挙動 |

---

## 実行手順

### Step 1: メモリの確認（必須）

1. `list_memories` で既存メモリを確認
2. `user-personas` があれば読み込む
3. `competitor-analysis` があれば読み込む

### Step 2: 既存要件の確認

`.claude/requirements/` 配下の関連ファイルを確認:

```bash
# 関連する要件定義書があるか確認
ls .claude/requirements/
```

| ファイル | 内容 |
|----------|------|
| `requirements-v1.md` | プロジェクト全体の基本要件 |
| `requirements-*.md` | 機能別の詳細要件 |

### Step 3: ヒアリング開始

**最初に聞く3つの質問**（AskUserQuestion ツールを使用）:

1. 「この機能を使うのは誰？」
   - 田中さん（週末GM・30代）: 日程調整やシナリオ探しを効率化したい
   - 鈴木さん（新人PL・20代）: 初心者向けセッションを見つけたい
   - 佐藤さん（配信者・20代）: 動画とセッションを連携したい
   - 山田さん（ベテランKP・40代）: 所持シナリオの管理とマッチング

2. 「具体的にどんな状況で使う？」
   - シナリオA: セッションを企画する
   - シナリオB: セッションに参加する
   - シナリオC: シナリオを探す

3. 「今はどうやってる？何が不便？」

### Step 4: 詳細ヒアリング

**操作フローを確認**:
- 「最初に何をクリックする？」
- 「何を入力する？」
- 「結果として何が見える？」

**TRPG特有の確認**:
- ネタバレの可能性は？
- 荒らし対策は必要？
- GM/PLで見える情報は変わる？

**TDDに必要な詳細**:
- 入力値のバリデーションルール（文字数、形式、必須/任意）
- 正常系・異常系の期待動作
- 境界値（最小/最大、0件時の挙動）
- エラーメッセージの文言

### Step 5: ドキュメント化

要件が固まったら `.claude/requirements/<機能名>.md` に出力。

```bash
# 例: シナリオ検索機能
.claude/requirements/scenario-search.md

# 例: フィードバック機能
.claude/requirements/feedback.md
```

### Step 6: PROGRESS.md更新（必須）

要件定義完了後、PROGRESS.mdのTDD進捗テーブルを更新:

```markdown
## TDD進捗: <機能名>

| 対象 | 要件定義 | テスト設計 | テスト実装 | 機能実装 | リファクタ | 状態 |
|------|:-------:|:--------:|:--------:|:-------:|:---------:|------|
| <関数/コンポーネント名> | ✅ | ⬜ | ⬜ | ⬜ | ⬜ | 要件定義済 |
```

---

## 出力フォーマット

```markdown
# [機能名] 要件定義書

**作成日**: YYYY-MM-DD
**TDDフェーズ**: 要件定義

---

## 1. 概要

### 1.1 目的
この機能が解決する課題を1-2文で。

### 1.2 対象ユーザー
主に利用するペルソナを明記。

### 1.3 ユーザーストーリー
「〇〇として、△△したい。なぜなら□□だから。」

---

## 2. 機能要件

### 2.1 画面・操作フロー

### 2.2 データ項目

| 項目 | 型 | 必須 | バリデーション | 説明 |
|------|-----|------|---------------|------|
| name | string | ○ | 1-100文字 | 名前 |

### 2.3 ビジネスルール

---

## 3. TRPGセッション固有の考慮事項

### 3.1 ネタバレ保護
### 3.2 荒らし対策

---

## 4. テスト観点（/gen-test への引き継ぎ）

### 4.1 正常系
- [ ] ケース1: 〇〇の場合、△△となる

### 4.2 異常系・境界値
- [ ] ケース2: 空文字の場合、エラーメッセージ「XXX」
- [ ] ケース3: 上限値を超えた場合、エラー

### 4.3 権限制御
- [ ] 未ログイン時: アクセス不可
- [ ] MEMBER: 閲覧のみ
- [ ] MODERATOR: 編集可能

---

## 5. 実装の優先度

### 5.1 MVP（必須）
### 5.2 Nice to Have（後回し可）

---

## 6. 未決定事項

---

## 7. TDD対象一覧

| 対象 | 種別 | ファイルパス | 備考 |
|------|------|-------------|------|
| searchFormSchema | Zodスキーマ | `src/app/(main)/scenarios/_components/schema.ts` | |
| searchScenarios | adapter関数 | `src/app/(main)/scenarios/adapter.ts` | |
```

---

## ヒアリングのコツ

1. **2-3問ずつ質問**: 一度に大量に聞かない
2. **具体例を出す**: 「例えばCoC7版で4人セッションのとき...」
3. **選択肢を提示**: 「AとBどちらに近い？」
4. **要約で確認**: 「つまり〇〇ということですね？」
5. **テスト観点を意識**: 「この値が空だったらどうなるべき？」

---

## ナレッジ蓄積

新しいペルソナや利用シーンを発見したら、対話終了時に `user-personas` メモリに追記する。

蓄積すべき情報:
- 既存4ペルソナに当てはまらない新ペルソナ
- 既存シナリオA/B/Cに当てはまらない利用シーン
- 要件に影響する具体的な悩み
- ドメイン用語（「野良卓」「身内卓」等）

---

## 参照ファイル

| ファイル | 用途 |
|----------|------|
| `.claude/requirements/requirements-v1.md` | プロジェクト全体の基本要件 |
| `.claude/requirements/` | 機能別要件定義書 |
| `user-personas` メモリ | ペルソナ・利用シーン |
| `competitor-analysis` メモリ | 競合分析 |

---

## 質問フレームワーク（チートシート）

### Phase 1: 誰が・いつ・何を
- 一番使うのは誰？
- どんな状況で？
- 今の方法と何が不便？

### Phase 2: どうやって
- 最初の操作は？
- 入力するものは？
- 結果として何が見える？

### Phase 3: TRPG特有
- ネタバレリスクは？
- 荒らし対策は？
- 権限管理は？

### Phase 4: TDD詳細
- バリデーションルールは？
- 空/null/上限超えの時は？
- エラーメッセージは？

### Phase 5: 優先度
- MVPは？
- あったら嬉しいけど後でいい機能は？

---

## 次のフェーズへの引き継ぎ

要件定義完了後、以下を伝達:

```
要件定義が完了しました。

📄 要件定義書: .claude/requirements/<機能名>.md
📊 PROGRESS.md: 更新済み

次のフェーズ:
/gen-test <機能名>
```
