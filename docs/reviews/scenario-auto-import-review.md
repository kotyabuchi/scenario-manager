# シナリオ自動取り込み機能 レビューレポート（第2回）

> **レビュー日時**: 2026-02-10
> **対象ファイル**: `docs/plans/scenario-auto-import.md`
> **総合評価**: B+
> **前回評価**: B → 指摘14件中12件反映済み
>
> **反映ステータス**: 反映済み（2026-02-10）
> **反映内容**: 必須 3件 + 推奨 4件 + 検討 3件（全10件）

## サマリー

前回レビュー（評価B）で指摘した必須4件・推奨6件・検討4件のうち、12件が計画書に反映済み。特にセキュリティ対策（SSRF、サニタイズ、レートリミット、タイムアウト）とプロジェクト規約準拠（Result型、LogTape、ENUM型）の反映が適切。UIアーキテクチャも「単一ページ2ステップ構成」に簡素化され、実装の複雑さが大幅に低減。ただし、**Edge Runtimeでのメモリキャッシュの実現可能性**、**プレイ時間の単位変換**、**source_urlとdistribute_urlの関係性**など、実装フェーズで問題になりうる技術的課題が残存。

## 前回指摘の反映状況

### 必須（4件）

| # | 指摘事項 | 反映状況 | 備考 |
|---|---------|---------|------|
| 1 | SSRF対策（ドメインホワイトリスト） | ✅ 反映済み | `url-validator.ts` にドメイン検証、localhost/プライベートIP/file://ブロック |
| 2 | パーサー出力のサニタイズ | ✅ 反映済み | `sanitizer.ts` でHTMLタグ・制御文字除去 |
| 3 | Edge RuntimeでのHTMLパーサー互換性 | ✅ 反映済み | cheerio第一候補、フォールバックとしてAPI Route (nodejs) |
| 4 | 既存フォームとの統合方針 | ✅ 反映済み | 別ページ `/scenarios/import` に分離（既存フォーム変更なし） |

### 推奨（6件）

| # | 指摘事項 | 反映状況 | 備考 |
|---|---------|---------|------|
| 1 | ENUM型でSingle Source of Truth | ✅ 反映済み | `scenario_source_type` ENUM型をDBに作成 |
| 2 | Result型パターン使用 | ✅ 反映済み | パーサー戻り値を `Result<ParsedScenario>` に |
| 3 | DBスキーマのTEXT型 | ✅ 反映済み | `source_url TEXT` に変更 |
| 4 | パーサーのレートリミット | ✅ 反映済み | ユーザーあたり1分5回 |
| 5 | 外部フェッチのタイムアウト | ✅ 反映済み | AbortController 10秒、レスポンスサイズ5MB |
| 6 | テスト戦略の具体化 | ✅ 反映済み | HTMLフィクスチャベースのユニットテスト、E2Eテスト |

### 検討（4件）

| # | 指摘事項 | 反映状況 | 備考 |
|---|---------|---------|------|
| 1 | Strategy Patternインターフェース | ✅ 反映済み | `ScenarioParser` インターフェース、`ParsedField<T>` 型 |
| 2 | URL解析結果のキャッシュ | ✅ 反映済み | 同一URLを1時間メモリキャッシュ |
| 3 | 利用規約調査 | ⚠️ 一部反映 | 「実装前に確認すること」の記載はあるが、調査結果自体は未完了 |
| 4 | ローディングUI | ❌ 未反映 | 軽微。実装時に対応可能 |

---

## 評価詳細

### 1. 技術的妥当性 WARN

**良い点**:
- サーバーサイドフェッチ + Server Actionの設計が明確
- `src/lib/scenario-fetcher/` への責務分離が適切
- HTMLパーサーのフォールバック戦略（Edge → nodejs API Route）を記載
- `ParsedField<T>` 型による信頼度の型表現が優れている

**新たな懸念点**:
- **メモリキャッシュのEdge Runtime互換性**: 計画書に「同一URLの解析結果を1時間程度メモリキャッシュ」とあるが、Cloudflare Pages（Edge Runtime）ではリクエストごとにワーカーが異なるため、**プロセス内メモリキャッシュは事実上無効**。Cloudflare KV、D1、またはキャッシュAPI（`caches.default`）を使うか、キャッシュ自体を見送るかの判断が必要
- **cheerioのEdge Runtime互換性**: cheerio v1.0.0以降は `htmlparser2` + `domhandler` に依存しており、Cloudflare Workersで動作実績がある。ただし、**バンドルサイズ**（cheerioは約200KB gzipped）がCloudflare Pages の制限（圧縮後1MB、非圧縮25MB）に収まるか検証が必要。フォールバックのnodejs API Routeが現実的な選択肢
- **プレイ時間の単位**: 既存DBは`min_playtime`/`max_playtime`を**秒単位**で保存しているが、計画書のUIモックでは「4〜6時間」表記。パーサーが抽出する値の単位（分? 時間?）と秒への変換処理が未定義
- **配布URLの正規化**: 既存の `checkDistributeUrlDuplicate()` は末尾スラッシュを除去する正規化を行っている。パーサーが `source_url` をセットする際も同じ正規化を適用すべきだが未言及

### 2. 網羅性・考慮漏れ WARN

**良い点**:
- 前回指摘のSSRF、タイムアウト、レートリミット、キャッシュがすべて反映
- E2Eテスト項目がサイト特性別のフィールド編集可否検証を含む
- 解析失敗時の `/scenarios/new` への導線が明記

**残存する考慮漏れ**:
- **`source_url` と `distribute_url` の関係**: インポート時、`source_url`（取り込み元URL）と `distribute_url`（配布URL）は同一値になるのか、別々に管理するのか未定義。既存の `distribute_url` 重複チェック（`checkDistributeUrlDuplicate()`）はインポート時にも適用されるべきだが、`source_url` との重複チェックとの関係が曖昧
- **同一URL再インポート時の動作**: 既にインポート済みの `source_url` で再度インポートを試みた場合の動作が未定義。重複エラーにするのか、上書き更新を許可するのか
- **パーサーのHTML構造変更耐性**: Booth/TALTOのHTML構造が変更された場合、パーサーが完全に壊れる。構造変更を検知する仕組み（特定のセレクタが見つからない場合のwarning等）や、変更頻度のモニタリング方針がない
- **既存の `createScenario()` adapter関数の拡張**: `adapter.ts` の `createScenario()` に `source_type`, `source_url`, `source_fetched_at` パラメータを追加する必要があるが、実装ファイル一覧に `adapter.ts` の変更が記載されていない
- **`CreateScenarioInput` 型の拡張**: `interface.ts` の既存型にsource関連フィールドを追加する必要があるが未記載

### 3. セキュリティ OK

**良い点**:
- SSRF対策（ドメインホワイトリスト、localhost/プライベートIPブロック）が具体的
- パーサー出力のサニタイズ（HTMLタグ・制御文字除去）が設計済み
- レートリミット（1分5回）でDoS対策
- タイムアウト（10秒）+ レスポンスサイズ上限（5MB）で過大リクエスト対策
- 概要文・画像の自動取り込み禁止で著作権リスク回避

**軽微な改善余地**:
- URLバリデーションで `javascript:` プロトコルのブロックも明示するとより堅牢（`file://` はブロック対象に含まれている）
- サニタイズ処理の具体的な実装方針（ライブラリ使用 vs 自前実装）が未記載だが、実装時に決定可能

### 4. UX・アクセシビリティ OK

**良い点**:
- 2ステップフロー（URL入力 → フォーム）が直感的
- `confidence` ベースの readOnly/編集可能制御がユーザビリティとデータ品質を両立
- 解析失敗時の手動入力（`/scenarios/new`）への導線が明記
- 「配布ページを見る」リンクで元サイトへの送客を配慮

**改善余地**:
- URL解析中のローディングUI（スケルトン or スピナー）の設計が未記載だが、実装時に対応可能
- readOnlyフィールドの視覚的区別（背景色変更等）の具体的なデザインが未記載
- Step 1 → Step 2 の切り替えアニメーションやトランジションの検討があるとUX向上

### 5. 保守性・拡張性 OK

**良い点**:
- `ParsedField<T>` + `confidence` の設計が秀逸。新規サイト追加時、パーサーがconfidenceを返すだけでUIが自動対応
- `ScenarioParser` インターフェースによるStrategy Patternで拡張ポイントが明確
- サイトごとのパーサー分離（`booth-parser.ts`, `talto-parser.ts`）で保守しやすい
- ENUM型 `scenario_source_type` で新規サイト追加時はENUM値を追加するだけ

**軽微な改善余地**:
- テストフィクスチャ（HTMLスナップショット）の配置ディレクトリ・更新方針が未記載（例: `src/lib/scenario-fetcher/__fixtures__/`）

### 6. プロジェクト整合性 OK

**良い点**:
- ENUM型 `scenario_source_type` でSingle Source of Truth原則に準拠
- パーサー戻り値に `Result<ParsedScenario>` を使用（`error-handling.md` 準拠）
- LogTape使用を明記（`logging.md` 準拠）
- ディレクトリ構造（`_components/`, `actions.ts`, `schema.ts`）が規約に準拠
- 別ページ `/scenarios/import` に分離し、既存の `/scenarios/new` に影響なし

**軽微な改善余地**:
- `src/db/enum.ts` への `SourceTypes` 追加は明記されているが、既存のEnum定義パターン（`as const` + Union型導出）に合わせるべき点を補足するとよい

### 7. 実行可能性 WARN

**良い点**:
- 6つのStepに分かれた段階的実装で進めやすい
- 各Stepの成果物とファイル一覧が具体的
- テスト戦略（ユニットテスト + E2Eテスト）が明確

**懸念点**:
- **Step 2の最大リスク「cheerio on Edge Runtime」の検証タイミング**: 実装に着手する前に、技術検証（PoC）を独立したStepとして設けるべき。検証結果によってはアーキテクチャ全体が変わる可能性がある
- **実装ファイル一覧の漏れ**: 以下のファイルが実装ファイル一覧に含まれていない
  - `src/app/(main)/scenarios/adapter.ts` — `createScenario()` にsourceパラメータ追加
  - `src/app/(main)/scenarios/interface.ts` — `CreateScenarioInput` 型にsourceフィールド追加
  - `src/lib/rateLimit.ts` — `parse_scenario_url` アクションの追加
- **マイグレーションの実行方法**: Supabase CLIのマイグレーション機能（`supabase migration new`）を使うのか、Dashboard SQLエディタで実行するのか。既存マイグレーション（`0000_sleepy_moonstone.sql` 等）との整合性維持の方針が未記載

---

## 改善提案

### 必須（実装前に対処すべき）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | 技術的妥当性 | メモリキャッシュがEdge Runtimeで機能しない。Cloudflare Pagesではリクエストごとにワーカーが異なり、プロセス内メモリは共有されない | キャッシュを見送る（MVP）か、Cloudflare KV/Cache APIを使用する設計に変更。または「キャッシュはnodejs API Route利用時のみ有効」と明記 |
| 2 | 網羅性 | `source_url` と `distribute_url` の関係が未定義。インポート時に両方に同じURLをセットするのか、それぞれ独立管理するのか不明 | `source_url`（パーサー用の元URL）= `distribute_url`（ユーザー向け配布リンク）とし、インポート時は `distribute_url` にも同値をセットする方針を明記 |
| 3 | 実行可能性 | 実装ファイル一覧に `adapter.ts`, `interface.ts`, `rateLimit.ts` の変更が漏れている | 実装ファイル一覧に既存ファイルの変更を追記 |

### 推奨（対応が望ましい）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | 技術的妥当性 | プレイ時間の単位変換が未定義。DBは秒単位、UIは時間/分表記 | パーサーが抽出する単位を明記し、秒への変換ルールを定義。既存の `ScenarioForm` の変換ロジックを参照 |
| 2 | 実行可能性 | Edge RuntimeでのHTMLパーサー検証をStep 2の前に独立PoCとして実施すべき | Step 1.5として「HTMLパーサーPoC」を追加。cheerioのバンドルサイズとCloudflare Pages制限の確認を含む |
| 3 | 網羅性 | 同一URL再インポート時の動作が未定義 | `distribute_url` の既存重複チェックで検知し、「既に登録済みです」エラーを表示する方針を明記 |
| 4 | 網羅性 | パーサーのHTML構造変更耐性 | 必要なセレクタが見つからない場合、パーサーは `err()` を返す仕様とし、ユーザーには「解析に失敗しました。手動で入力してください」と表示 |

### 検討（余裕があれば）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | UX | readOnlyフィールドの視覚的区別が未設計 | 背景色を変更（例: `gray.50`）し、ロックアイコンを付与。PandaCSSのセマンティックトークンで定義 |
| 2 | 網羅性 | Booth/TALTO利用規約の調査が未完了 | 実装着手前に利用規約を確認し、スクレイピングの可否を判断。結果を計画書に追記 |
| 3 | 保守性 | テストフィクスチャの配置・更新方針が未記載 | `src/lib/scenario-fetcher/__fixtures__/` に配置し、HTML構造変更時の更新手順を記載 |

---

## 総合所見

前回レビュー（評価B）からの改善が顕著。14件の指摘のうち12件が適切に反映され、計画の品質が大幅に向上した。特に以下の点が評価できる：

1. **UIアーキテクチャの簡素化**: 3フェーズ構成（モーダル → サイト別ページ）から単一ページ2ステップ構成に変更したことで、実装の複雑さが大幅に低減。React stateで完結する設計は、ページ間データ受け渡しの問題を根本的に解消している

2. **`ParsedField<T>` + confidence パターン**: フィールドの信頼度をパーサー層で宣言し、UI層が機械的に解釈する設計は、パーサーとUIの疎結合を実現しつつ、新規サイト追加時の拡張性を確保している。型システムを活用した優れた設計判断

3. **セキュリティ対策の網羅性**: SSRF、XSS、DoS、レートリミット、タイムアウトの5つの対策が具体的に設計され、実装可能なレベルに到達

**残存する主要リスク**:

1. **Edge Runtimeとの互換性**: メモリキャッシュの実現可能性とHTMLパーサーのバンドルサイズが最大の技術リスク。Step 2着手前にPoCを実施すべき
2. **データモデルの曖昧さ**: `source_url` と `distribute_url` の関係、同一URL再インポート時の動作など、実装時に判断が分かれる箇所がある
3. **実装ファイル一覧の漏れ**: 既存ファイル（`adapter.ts`, `interface.ts`, `rateLimit.ts`）の変更が一覧に含まれておらず、影響範囲が過小評価される恐れ

これらの課題は「必須」指摘3件で対処可能であり、対応後は実装フェーズに進めるレベル（A評価相当）になる。Step 2（パーサー実装）をTDDアプローチで進めることを引き続き推奨する。
