# E2Eテスト拡充計画 レビューレポート（第2回）

> **反映ステータス**: 反映済み（2026-02-11）
> **反映内容**: 必須 1件 + 推奨 1件 + 検討 0件

> **レビュー日時**: 2026-02-11
> **対象ファイル**: `docs/plans/e2e-test-expansion.md`
> **総合評価**: B

## サマリー

前回レビュー（評価C）で指摘した必須2件・推奨3件・検討3件の全8件が適切に反映されており、計画の品質が大幅に改善された。ファイル命名バグの修正、CIクリーンアップ戦略の明記、タブ動作の考慮、前提条件の明確化など、いずれも的確な対応。残る問題は **`aria-current` 属性がGlobalHeaderに未実装**である点のみで、テスト1-5の修正が必要。

## 前回レビュー指摘の反映状況

| # | 種別 | 指摘 | 状況 |
|---|------|------|------|
| 必須1 | 技術的妥当性 | `auth-redirect.spec.ts` の命名バグ | ✅ `redirect.spec.ts` に変更済み |
| 必須2 | 実行可能性 | CIに `SUPABASE_SERVICE_ROLE_KEY` がない | ✅ CI secrets + workflow への追加手順を明記 |
| 推奨1 | UX・a11y | a11yスコープの不一致 | ✅ `.include('header').include('main').include('footer')` に統一 |
| 推奨2 | 技術的妥当性 | `<Link><button disabled>` 構造の問題 | ✅ LoginPrompt表示で検証する設計に変更 |
| 推奨3 | 網羅性 | セッション詳細の未計画 | ✅ 「今後の拡張（次バッチ候補）」に明記 |
| 検討1 | 網羅性 | シードデータの前提不明確 | ✅ 前提条件として明記 |
| 検討2 | 網羅性 | ウェルカムメッセージの前提 | ✅ `full_name` 設定前提を明記 |
| 検討3 | 保守性 | プロフィール編集テスト統合 | ✅ 2テスト + afterAll復元に整理 |

## 評価詳細

### 1. 技術的妥当性 WARN

**良い点**:
- `e2e/redirect.spec.ts` への命名修正で `testIgnore: [/auth/]` との衝突を回避
- タブナビゲーションの検証設計が実装に即している（LoginPrompt表示を確認）
- Batch分割の段階的アプローチは引き続き適切

**問題点**:

**(a) テスト1-5 `aria-current` が GlobalHeaderに未実装（Important）**

計画のテスト「アクティブなナビリンクが `aria-current` を持つ」は、GlobalHeaderの実装と不整合。`src/components/blocks/GlobalHeader/index.tsx:73` ではCSSバリアント `styles.navLink({ active })` のみでアクティブ状態を表現しており、`aria-current` 属性は設定されていない。

`aria-current` はプロジェクト内ではページネーションコンポーネント（`pagination.tsx:125`）でのみ使用されている。

**対応方針（2択）**:
- (A) GlobalHeaderに `aria-current="page"` を追加実装し、テストをそのまま実行（WCAG推奨）
- (B) テスト1-5をアクティブCSSクラスの検証に変更（例: active状態の視覚的インジケーターの存在確認）

WCAG 2.1 AAの観点からは (A) が望ましい。ナビゲーションのアクティブ状態をスクリーンリーダーに伝えるため。

### 2. 網羅性・考慮漏れ OK

前回指摘の以下が改善済み:
- シードデータの前提条件が明記された
- テストユーザーの `full_name` 設定が前提条件に追加された
- カバー対象外のページが「今後の拡張」に明記された
- `/home` のredirectなし挙動がテスト対象外として明記された

### 3. セキュリティ OK

- Service Role Keyの管理方針が明確化された（CI secrets経由）
- 環境変数未設定時のgraceful skip（ローカル開発での許容）も適切
- テストデータの `[E2E]` プレフィックス命名規則は手動クリーンアップにも有用

### 4. UX・アクセシビリティ WARN

**改善済み**:
- a11yテストスコープが `.include('header').include('main').include('footer')` に統一

**注意点**:

**(a) 既存 `smoke.spec.ts` のランディングページa11yテストとの不整合**

既存の `smoke.spec.ts:27-31` のランディングページa11yテストは `.include('main')` のみ。計画で追加する新規a11yテストは `.include('header').include('main').include('footer')` を使用する。同一ファイル内でスコープが異なる状態になる。

これは計画の問題ではなく既存コードの問題だが、`smoke.spec.ts` にテストを追加する際に既存テストのスコープも統一するか検討する価値がある。

**(b) `disableRules(['color-contrast'])` の継続使用**

全a11yテストでカラーコントラストを除外し続けている。コメントに理由（primary.500の意図的選択）が記載されているが、セマンティックトークン修正（MEMORY.md記載: primary.500→700への変更済み）により、一部ページでは除外不要になっている可能性がある。将来的なcolor-contrast有効化の検討を推奨。

### 5. 保守性・拡張性 OK

- Page Object分離が適切
- Batchごとの独立性が高く段階的実装可能
- `cleanup.ts` ヘルパーの共通化で再利用性確保
- プロフィール編集テストの `beforeAll`/`afterAll` によるデータ管理が堅実

### 6. プロジェクト整合性 OK

- `domcontentloaded` 使用、`:visible` 疑似セレクタ等のプロジェクトパターンを踏襲
- ファイル命名規則（kebab-case）準拠
- テストの日本語記述パターンも一致
- `test.skip()` による環境変数依存テストの条件分岐も一致

### 7. 実行可能性 OK

前回指摘のCI環境変数問題が解決済み:
- `SUPABASE_SERVICE_ROLE_KEY` の追加手順が明記
- 未設定時のスキップ動作も明記
- 検証コマンドが具体的に記載

## 改善提案

### 必須（実装前に対処すべき）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | 技術的妥当性 | テスト1-5「`aria-current` を持つ」がGlobalHeaderに未実装のため失敗する | (A) GlobalHeaderに `aria-current="page"` を実装追加（WCAG推奨）、または (B) テストをアクティブ状態の視覚的インジケーター検証に変更 |

### 推奨（対応が望ましい）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | UX・a11y | `smoke.spec.ts` 内でランディングページのa11yスコープ（`.include('main')` のみ）が新規テストのスコープと不整合 | テスト追加時に既存ランディングページテストも `.include('header').include('main').include('footer')` に統一 |

### 検討（余裕があれば）

| # | 視点 | 指摘事項 | 推奨対応 |
|---|------|---------|---------|
| 1 | UX・a11y | `disableRules(['color-contrast'])` がセマンティックトークン修正後も継続されている | 修正済みページのcolor-contrastルール有効化を将来的に検討 |

## 総合所見

前回レビュー（評価C）からの改善は非常に的確で、8件の指摘すべてが適切に反映されている。計画の全体構成、Batch分割、データ管理戦略、前提条件の明記など、実装に入る準備が十分に整っている。

残る必須指摘は `aria-current` の1件のみ。これはテスト計画と実装の不整合であり、方針を決定すれば（実装追加 or テスト変更）即座に実装開始可能な品質の計画である。前回のB→Cを引き起こした2つの重大問題が解消されたことで、今回はB評価（軽微な改善点あり、修正後に実装可能）とする。
